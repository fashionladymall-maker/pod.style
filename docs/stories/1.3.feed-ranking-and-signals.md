
# Story 1.3: Feed Ranking Signals Integration

## Status
Ready for Review

## Story
**As a** product team optimizing discovery on Pod.Style,
**I want** the feed service to rank entries using engagement and personalization signals,
**so that** users see relevant creations that reflect popularity, freshness, and personal taste without breaking legacy behavior.

## Acceptance Criteria
1. `feed-service` aggregates ranking inputs (likeCount, favoriteCount, shareCount, commentCount, remakeCount, orderCount, createdAt recency, personalization boosts) and produces a composite score used to order feed results before returning them to server actions.  
2. `personalized_feed_cache` documents are populated or backfilled with the new `rankingSignals` map (e.g., `engagementScore`, `recencyBoost`, `personalBoost`) without breaking the existing Cloud Function writers.  
3. Server actions expose ranking metadata to the client (for debugging/logging) while keeping user-facing payloads backward compatible and hiding internal scoring details when flag disabled.  
4. Unit tests validate composite scoring logic across high-engagement, fresh, and personalized scenarios; integration tests confirm feed ordering on `/beta` respects the new ranking.  
5. Telemetry captures ranking score distribution and cache hit ratios, enabling dashboards/alerts for anomalies.

## Tasks / Subtasks
- [x] Define ranking model (AC: 1)  
  - [x] Implement scoring utility (e.g., `calculateFeedScore`) combining engagement, recency, and personalization weights.  
  - [x] Document chosen weights/boosts in architecture change log.  
- [x] Extend cache schema handling (AC: 2)  
  - [x] Update feed service to read/write `rankingSignals` map, ensuring compatibility with existing Cloud Function data.  
  - [x] Provide fallback values when signals missing.  
- [x] Server action adjustments (AC: 3)  
  - [x] Expose ranking metadata in server action return (for internal diagnostics) while guarding behind feature flag.  
  - [x] Maintain backward-compatible payload for legacy clients.  
- [x] Testing (AC: 4)  
  - [x] Add unit tests covering scoring edge cases (high engagement vs recent vs personalization).  
  - [x] Update Playwright integration test to assert ordering on `/beta`.  
- [x] Telemetry & monitoring (AC: 5)  
  - [x] Emit metrics (`feed.service.ranking.score_distribution`, `feed.service.cache.hit_ratio`) and ensure dashboards track them.  
  - [x] Add alert thresholds in observability documentation.

## Dev Notes
### Previous Story Insights
- Story 1.1 established feed route/flag; Story 1.2 implemented cache/pagination with metrics.
- This story builds on the same feed service, adding ranking computations.

### Data Models
- `personalized_feed_cache` now includes `rankingSignals` map (engagement/recency/personalization components).  
  `[Source: architecture.md#5-data-architecture]`
- Interaction metrics (likeCount, favoriteCount, shareCount, commentCount, remakeCount, orderCount) stored in `creations`; service must read these fields safely.  
  `[Source: architecture-brownfield.md#53-data-model]`

### API & Service Specifications
- Feed service is responsible for ranking and pagination; scoring should occur before returning to server actions.  
  `[Source: architecture.md#4-application-architecture]`
- Cloud Function `updatePersonalizedFeedCache` populates cache entries; ranking augmentation must align with its structure without requiring immediate function change.  
  `[Source: architecture-brownfield.md#52-backend-services]`

### Component Specifications
- Client feed rendering remains as is; ranking metadata surfaced only for diagnostics (e.g., developer console or metrics), not user UI.  
  `[Source: architecture.md#3-business-user-experience-architecture]`

### File Locations & Project Structure
- Ranking utilities can live within `src/features/feed/server/feed-service.ts` or extracted helper (e.g., `feed-ranking.ts`).  
  `[Source: architecture.md#41-components--responsibilities]`
- Telemetry logic should reuse existing logger utilities noted in architecture.  
  `[Source: architecture.md#74-observability]`

### Testing Requirements
- Unit tests: Jest, `src/features/feed/__tests__/feed-ranking.test.ts`, covering multiple scoring scenarios.  
  `[Source: architecture.md#8-testing-strategy]`
- Integration tests: Playwright verifying `/beta` ordering changes reflect ranking; ensure legacy `/` unaffected.  
  `[Source: architecture.md#8-testing-strategy]`

### Technical Constraints
- Backward compatibility: new signals must not break legacy cache entries or readers; ensure optional handling.  
  `[Source: architecture.md#2-Enhancement-Scope-and-Integration-Strategy]`
- Feature flag gating continues; ranking should only affect `/beta` until rollout.  
  `[Source: architecture.md#11-next-steps]`

## Testing
- Jest unit tests for ranking utility (engagement vs recency vs personalization).  `[Source: architecture.md#8-testing-strategy]`
- Playwright integration test checking `/beta` feed ordering and diagnostics output.  `[Source: architecture.md#8-testing-strategy]`
- Manual regression to confirm legacy `/` ordering unchanged when flag off.  `[Source: architecture.md#73-deployment-strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Initial draft focusing on ranking signals | Bob (scrum-master) |
| 2025-03-02 | v0.2 | 实现排名权重、指标与自动化测试 | James (dev) |

## QA Results

### Review Date: 2025-09-28
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 文档结构完整，但多处 `[Source: ...]` 锚点仍使用原始标题大小写或小数点，无法正确跳转；故事状态也未进入 `Ready`。

#### Test Strategy & Coverage
- 仅进行文档级审查，未评估测试覆盖。

#### NFR Assessment
- Not assessed。

#### Issues
1. 锚点需全部转换为 Markdown slug 形式：
   - `architecture.md#5-data-architecture` → `architecture.md#5-data-architecture`
   - `architecture-brownfield.md#53-data-model` → `architecture-brownfield.md#53-data-model`
   - `architecture.md#4-application-architecture` → `architecture.md#4-application-architecture`
   - `architecture-brownfield.md#52-backend-services` → `architecture-brownfield.md#52-backend-services`
   - `architecture.md#3-business-user-experience-architecture` → `architecture.md#3-business-user-experience-architecture`
   - `architecture.md#41-components--responsibilities` → `architecture.md#41-components--responsibilities`
   - `architecture.md#74-observability` → `architecture.md#74-observability`
   - `architecture.md#11-next-steps` → `architecture.md#11-next-steps`
   - `architecture.md#73-deployment-strategy` → `architecture.md#73-deployment-strategy`
2. `Status` 仍为 `Draft`，需在准备完成后更新为 `Ready`。`docs/stories/1.3.feed-ranking-and-signals.md:4`

#### Recommendations
- 修正以上锚点并验证跳转；状态同步更新。

#### Suggested Status
- Changes Required

### Review Date: 2025-09-28 (二次复核)
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 全部 `[Source: ...]` 锚点已转换为 Markdown slug，导航行为正常；故事状态更新为 `Ready`，与规划阶段一致。

#### Test Strategy & Coverage
- 尚无实现代码，本次仅确认文档准备度。

#### NFR Assessment
- Not assessed。

#### Issues
- None.

#### Recommendations
- 实施排名信号时，请为高参与度、最新内容及个性化场景编写单元测试覆盖，并确保指标输出可观测。

#### Suggested Status
- Pass

## Dev Agent Record
### Agent Model Used
- James (GPT-5)

### Debug Log References
- `npm run lint`
- `npm run typecheck`
- `npm run test -- feed-service`

### Completion Notes List
- 引入 `calculateFeedScore` 排名模型，结合参与度、时效性、个性化并输出分布指标。
- 更新 feed service/cache/fallback 流程，排序仅在排名开关开启时生效并记录命中率。
- 扩展 Jest/Playwright 覆盖与文档（架构/故事）说明，暴露 `data-feed-score` 供调试。

### File List
- src/features/feed/config.ts
- src/features/feed/server/feed-service.ts
- src/features/feed/server/ranking.ts
- src/features/feed/__tests__/feed-service.test.ts
- src/features/feed/__tests__/feed-ranking.test.ts
- src/components/screens/feed-screen.tsx
- src/components/screens/home-screen.tsx
- src/features/creations/server/creation-repository.ts
- src/features/orders/server/order-repository.ts
- src/app/api/image-proxy/route.ts
- tests/integration/feed.spec.ts
- docs/architecture.md
- docs/stories/1.3.feed-ranking-and-signals.md
