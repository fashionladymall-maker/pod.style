
# Story 3.4: Order Tracking & Notifications

## Status
Draft

## Story
**As a** customer awaiting delivery,
**I want** real-time order tracking updates and notifications,
**so that** I know the status of my purchase from processing to delivery.

## Acceptance Criteria
1. Orders view (for authenticated users) displays tracking timeline based on `orders.statusHistory`, including timestamps, status notes, and links to carrier tracking page.  
2. Notification pipeline (email/Push/in-app) alerts customers when order status changes (Processing → Shipped → Delivered or Cancelled), respecting moderation/safety guidelines.  
3. Guest users receive email notifications with limited tracking info and a secure link to view order status (without full account).  
4. Observability logs notification success/failure, tracking updates, and triggers alerts when status updates fail to send.  
5. Tests cover tracking display, notification triggers, guest email flows, and regression to ensure legacy mock checkout unaffected when feature flag disabled.

## Tasks / Subtasks
- [ ] Orders UI (AC: 1)  
  - [ ] Extend `(shop)/orders` page to show status timeline per order.  
  - [ ] Include carrier tracking link when available.  
- [ ] Notification integration (AC: 2)  
  - [ ] Update notification service to send messages on status change events.  
  - [ ] Ensure templates vary for auth vs guest.  
- [ ] Guest access (AC: 3)  
  - [ ] Send secure link (signed URL/token) to guest for order tracking page.  
  - [ ] Ensure link expires or requires verification.  
- [ ] Observability (AC: 4)  
  - [ ] Emit metrics (`order.tracking.notification.success`) and log failures.  
  - [ ] Document dashboards/alerts for missing updates.  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for notification triggers.  
  - [ ] Playwright tests for orders UI (auth + guest link).  
  - [ ] Manual regression ensuring legacy path unaffected when notifications disabled.

## Dev Notes
### Data Models
- `orders.statusHistory` already stores status events; ensure timeline uses this data.  
  `[Source: architecture.md#5-Data-Architecture]`

### Services
- Notification pipeline detailed in architecture; reuse existing modules.  
  `[Source: architecture-brownfield.md#5.2-Backend-Services]`

### UI Considerations
- Orders page must be responsive; ensure secure guest access flow.  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Locations
- UI under `(shop)/orders` and `src/components/screens/order-detail.tsx`.  
  `[Source: architecture.md#4.1-Components-&-Responsibilities]`
- Notifications in `src/features/orders/server/order-notifications.ts`.  
  `[Source: architecture.md#4-Application-Architecture]`

### Testing Requirements
- Unit tests for notification triggers; integration tests for UI.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Feature flag gating notifications; fallback to current manual updates.  
  `[Source: architecture.md#Next-Steps]`
- Security: ensure guest links are signed/expire.  
  `[Source: architecture.md#9-Security-Integration]`

## Testing
- Jest tests for notification triggers. `[Source: architecture.md#8-Testing-Strategy]`
- Playwright tests for tracking UI. `[Source: architecture.md#8-Testing-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Draft for order tracking & notifications | Bob (scrum-master) |
