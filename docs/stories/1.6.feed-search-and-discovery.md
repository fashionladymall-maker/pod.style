
# Story 1.6: Feed Search & Discovery

## Status
Ready

## Story
**As a** user exploring Pod.Style content,
**I want** to search feed entries by keyword and hashtags with localized filtering,
**so that** I can quickly discover creations relevant to my interests without losing the curated experience.

## Acceptance Criteria
1. Feed server actions expose a search entry point (`searchFeed`) that accepts query text, optional hashtag filters, and region parameters, returning ranked results consistent with Stories 1.2–1.4 scoring rules.  
2. Firestore queries leverage indexed fields on `personalized_feed_cache` / `feed_entries` (e.g., `hashtags`, `caption`, `region`, `rankingSignals`) and gracefully fall back to legacy `creations` when cache misses occur.  
3. The `(feed)` client provides a search UI (search bar + optional filter chips) that invokes the search action, shows results, and allows users to clear the query to return to the default feed.  
4. Observability records search usage, query performance, and fallback counts, ensuring dashboards can monitor search latency and hit rates.  
5. Tests cover search service logic, Firestore index usage, and UI flow, including cases with no results and with flag disabled.

## Tasks / Subtasks
- [ ] Server-side search API (AC: 1,2)  
  - [ ] Implement `searchFeed` in `src/features/feed/server/actions.ts` delegating to service logic with Zod validation.  
  - [ ] Extend `feed-service` with search query function applying ranking + fallback.  
- [ ] Firestore indexing / fallback (AC: 2)  
  - [ ] Ensure composite indexes exist for `hashtags` + `region` + `updatedAt`; document required index config.  
  - [ ] Implement fallback to `creations` when cache query empty or index unavailable.  
- [ ] Client UI integration (AC: 3)  
  - [ ] Add search bar plus filter UI (e.g., hashtag chips) in `FeedScreen`.  
  - [ ] Handle loading, empty state, and clearing search results gracefully.  
- [ ] Observability (AC: 4)  
  - [ ] Emit metrics (`feed.search.latency`, `feed.search.cacheHit`) and log query metadata (with privacy considerations).  
  - [ ] Update documentation describing dashboards/alerts for search performance.  
- [ ] Testing (AC: 5)  
  - [ ] Jest unit tests for search service (cache hit, fallback, no-results).  
  - [ ] Playwright integration test verifying search UI flow on `/beta`.  
  - [ ] Manual regression confirming legacy `/` unaffected when flag off.

## Dev Notes
### Previous Story Insights
- Stories 1.1–1.5 delivered feed route, pagination, ranking, ingestion, and refresh. Search must reuse those services.

### Data Models
- `personalized_feed_cache` / `feed_entries` contain captions, hashtags, region info; ensure queries respect optional fields.  
  `[Source: architecture.md#5-data-architecture]`
- `creations` retains metadata for fallback; avoid unindexed scans.  
  `[Source: architecture-brownfield.md#53-data-model]`

### API & Service Specifications
- Feed service handles aggregation and ranking; extend to support search queries with same ranking factors.  
  `[Source: architecture.md#4-application-architecture]`
- Search/discovery listed as feed requirement in PRD.  
  `[Source: prd.md#51-content--feed]`

### Component Specifications
- Search UI integrates into `(feed)` experience; maintain feature flag gating (`/beta`).  
  `[Source: architecture.md#3-business-user-experience-architecture]`

### File Locations & Project Structure
- Server logic: `src/features/feed/server/`; client UI: `src/components/screens/feed-screen.tsx` or a dedicated search component under `src/components/feed`.  
  `[Source: architecture.md#41-components--responsibilities]`
- Index configuration notes should be placed in deployment docs.  
  `[Source: architecture.md#73-deployment-strategy]`

### Testing Requirements
- Unit tests for search service covering cache hit/fallback; integration tests for UI; regression for legacy fallback.  
  `[Source: architecture.md#8-testing-strategy]`

### Technical Constraints
- Feature flag gating remains; search should be disabled when new feed off.  
  `[Source: architecture.md#11-next-steps]`
- Ensure privacy compliance: avoid logging full user queries where not allowed; anonymize metrics.  
  `[Source: architecture.md#74-observability]`

## Testing
- Jest unit tests for search service. `[Source: architecture.md#8-testing-strategy]`
- Playwright integration test for search UI and fallback. `[Source: architecture.md#8-testing-strategy]`
- Manual regression verifying legacy `/` unaffected. `[Source: architecture.md#73-deployment-strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Initial draft for feed search & discovery | Bob (scrum-master) |

## QA Results

### Review Date: 2025-09-28
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 锚点 slug 与状态问题依旧存在，影响引用准确性。

#### Test Strategy & Coverage
- 当前仅为需求文档，未涉及代码测试。

#### NFR Assessment
- Not assessed。

#### Issues
1. 调整引用为正确 slug：
   - `architecture.md#5-data-architecture` → `architecture.md#5-data-architecture`
   - `architecture-brownfield.md#53-data-model` → `architecture-brownfield.md#53-data-model`
   - `architecture.md#4-application-architecture` → `architecture.md#4-application-architecture`
   - `prd.md#51-content--feed` → `prd.md#51-content--feed`
   - `architecture.md#3-business-user-experience-architecture` → `architecture.md#3-business-user-experience-architecture`
   - `architecture.md#41-components--responsibilities` → `architecture.md#41-components--responsibilities`
   - `architecture.md#73-deployment-strategy` → `architecture.md#73-deployment-strategy`
   - `architecture.md#8-testing-strategy` (保持现状)
   - `architecture.md#11-next-steps` → `architecture.md#11-next-steps`
   - `architecture.md#74-observability` → `architecture.md#74-observability`
2. `Status` 需改为 `Ready`。`docs/stories/1.6.feed-search-and-discovery.md:4`

#### Recommendations
- 修正锚点后，更新状态并重新提交。

#### Suggested Status
- Changes Required

### Review Date: 2025-09-28 (二次复核)
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 所有引用 slug 已矫正，故事状态现为 `Ready`；搜索指标与索引说明可直接落地。

#### Test Strategy & Coverage
- 等待后续服务与 UI 实现，此次仅确认文档。

#### NFR Assessment
- Not assessed。

#### Issues
- None.

#### Recommendations
- 实现阶段注意 Firestore 索引配置与回退逻辑同步更新部署文档。

#### Suggested Status
- Pass
