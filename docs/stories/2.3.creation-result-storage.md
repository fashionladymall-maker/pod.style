
# Story 2.3: Creation Result Management & Storage

## Status
Draft

## Story
**As a** creator using the studio,
**I want** generated patterns and mockups to be saved to my workspace automatically,
**so that** I can review, manage, and reuse creations without repeating the generation process.

## Acceptance Criteria
1. When generation succeeds, server actions persist pattern and mockup assets to Firebase Storage (public preview + private source) following naming conventions (`creations/{userId}/{uuid}`), and create a draft `Creation` document in Firestore.  
2. Stored creation documents include prompt, style, summary (via `summarizePrompt`), models array (initially empty or with generated mockups), and flags indicating draft vs published state.  
3. UI provides a results gallery showing saved assets, allowing creators to rename, delete, or mark favorites prior to publishing.  
4. Implement retry/error handling for upload failures, including cleanup of orphaned files and fallback messaging.  
5. Tests cover storage uploads (with emulator or mocks), Firestore document creation, UI gallery interactions, and legacy behavior when feature flag disabled.

## Tasks / Subtasks
- [ ] Asset storage (AC: 1,4)  
  - [ ] Update server actions to upload pattern/modeled assets to Storage with correct metadata.  
  - [ ] Implement cleanup logic on failure (delete partial uploads).  
- [ ] Firestore draft creation (AC: 2)  
  - [ ] Create draft `Creation` document capturing prompt, style, summary, pattern URIs.  
  - [ ] Ensure compatibility with existing schema & future publish flow.  
- [ ] UI result gallery (AC: 3)  
  - [ ] Display saved assets with rename/delete/favorite controls.  
  - [ ] Confirm actions update Firestore & Storage accordingly.  
- [ ] Error handling (AC: 4)  
  - [ ] Add try/catch with user feedback and cleanup steps.  
  - [ ] Log errors with actionable details (`studio.storage.failure`).  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for server actions (success/failure paths).  
  - [ ] Playwright test verifying gallery operations.  
  - [ ] Manual regression ensuring feature flag fallback.

## Dev Notes
### Data Models
- Use `Creation` schema with fields: prompt, style, summary, patternUri, models[], createdAt, draft flags.  
  `[Source: architecture.md#5-Data-Architecture]`

### API & Service Specs
- Upload logic uses `uploadDataUriToStorage` and ensures public/private access as needed.  
  `[Source: architecture-brownfield.md#5.2-Backend-Services]`
- Summaries generated via `summarizePrompt`.  
  `[Source: architecture.md#4-Application-Architecture]`

### Component Specs
- Gallery component aligns with design tokens; operations triggered via server actions.  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Locations & Project Structure
- Storage logic in `src/features/creations/server/creation-service.ts`.  
  `[Source: architecture.md#4-Application-Architecture]`
- UI in `CreationStudioScreen` or sub-component.  
  `[Source: architecture.md#4.1-Components-&-Responsibilities]`

### Testing Requirements
- Storage + Firestore emulator tests; UI integration tests.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Ensure no orphaned files; use idempotent naming.  
  `[Source: architecture.md#2-Enhancement-Scope-and-Integration-Strategy]`
- Respect auth/security rules for uploads.  
  `[Source: architecture.md#9-Security-Integration]`

## Testing
- Jest/emulator tests for storage & Firestore writes. `[Source: architecture.md#8-Testing-Strategy]`
- Playwright tests for gallery interactions. `[Source: architecture.md#8-Testing-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Draft covering creation result storage | Bob (scrum-master) |
