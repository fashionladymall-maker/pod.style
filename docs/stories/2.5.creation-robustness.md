
# Story 2.5: Creation Robustness & Queue Management

## Status
Draft

## Story
**As a** creator relying on Pod.Style studio,
**I want** generation requests to handle failures gracefully and retry safely,
**so that** I trust the system even when AI providers or storage have hiccups.

## Acceptance Criteria
1. Introduce a queue or job management system for creation requests (e.g., Cloud Tasks/Pub/Sub) so long-running AI jobs are processed asynchronously with retry policies.  
2. Implement retry logic with exponential backoff for AI generation, storage uploads, and summary creation; failures surface user-friendly messages and log errors with correlation IDs.  
3. Provide status monitoring (pending, in progress, failed, completed) for generation jobs in Firestore, allowing UI to poll/apprise users.  
4. Build graceful fallback paths (e.g., offer to retry later, link to support) when repeated failures occur, and ensure no orphaned data remains.  
5. Tests cover queue dispatch/processing, retry behavior, job status updates, and UI handling under failure scenarios.

## Tasks / Subtasks
- [ ] Queue setup (AC: 1)  
  - [ ] Integrate Cloud Tasks or Pub/Sub queue for creation jobs.  
  - [ ] Update server actions to enqueue jobs instead of running synchronously.  
- [ ] Retry/backoff (AC: 2)  
  - [ ] Configure retry policies for AI flows, storage uploads, summaries.  
  - [ ] Log errors with correlation IDs (`studio.job.{id}`) and present user-friendly feedback.  
- [ ] Job status tracking (AC: 3)  
  - [ ] Store job states in Firestore (pending/in-progress/failed/completed).  
  - [ ] Provide API for UI polling (`getJobStatus`).  
- [ ] Fallback & cleanup (AC: 4)  
  - [ ] Remove partial assets on failure; present retry options.  
  - [ ] Document support escalation paths.  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for queue handlers & retries.  
  - [ ] Playwright/emulator tests simulating failure -> retry -> success.  
  - [ ] Manual regression ensuring retries donâ€™t duplicate records.

## Dev Notes
### Data Models & Services
- Job status documents should align with architecture guidelines (e.g., `generation_jobs` collection).  
  `[Source: architecture.md#4-Application-Architecture]`
- Queue integration must follow infrastructure plan (Cloud Tasks/Pub/Sub).  
  `[Source: architecture.md#7.2-Infrastructure-Changes]`

### Component Specs
- UI should show job status indicator and allow reattempts.  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Locations & Project Structure
- Queue handlers in `src/features/creations/server/job-handler.ts` or Cloud Functions.  
  `[Source: architecture.md#4-Application-Architecture]`
- Job status API under `studio-actions`.  
  `[Source: architecture.md#4.1-Components-&-Responsibilities]`

### Testing Requirements
- Integration tests for queue + Firestore updates.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Ensure retry policies respect provider rate limits.  
  `[Source: architecture.md#6-Integration-Architecture]`
- Security: job queue must enforce auth & avoid exposing PII.  
  `[Source: architecture.md#9-Security-Integration]`

## Testing
- Jest tests for queue handlers/retries. `[Source: architecture.md#8-Testing-Strategy]`
- Playwright/emulator tests for failure/retry flow. `[Source: architecture.md#8-Testing-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Draft for creation robustness & queue management | Bob (scrum-master) |
