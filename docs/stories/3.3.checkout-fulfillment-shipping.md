
# Story 3.3: Fulfillment & Shipping Integration

## Status
Draft

## Story
**As a** buyer awaiting delivery,
**I want** checkout to coordinate with shipping providers for rates, labels, and tracking,
**so that** I know when my custom creation will arrive.

## Acceptance Criteria
1. Integrate with logistics provider (e.g., EasyPost/ShipBob) to fetch rates during checkout based on destination, product attributes, and region; display options (standard/express) with costs.  
2. Upon order creation (Story 3.1/3.2), enqueue fulfillment job that requests shipping label/tracking info and updates `orders` with `fulfillmentStatus`, tracking IDs, and shipment events.  
3. UI displays shipping selection during checkout and shows tracking status post-purchase (on orders page), respecting feature flags.  
4. Observability logs fulfillment requests/responses, tracks failure rates, and alerts on fulfillment job errors.  
5. Tests cover rate fetching, order-fulfillment pipeline, UI display of shipping choices/tracking, and regression when logistics integration disabled.

## Tasks / Subtasks
- [ ] Rate lookup (AC: 1)  
  - [ ] Implement `shipping-service` to query provider for rate options.  
  - [ ] Update checkout UI to present rates and store selection.  
- [ ] Fulfillment job (AC: 2)  
  - [ ] Queue job to generate shipping label and update order with tracking details.  
  - [ ] Handle status updates (Processing/Shipped/Delivered).  
- [ ] UI updates (AC: 3)  
  - [ ] Show shipping options in checkout; reflect chosen option in order summary.  
  - [ ] Display tracking status on order detail page.  
- [ ] Observability (AC: 4)  
  - [ ] Log fulfillment interactions (`fulfillment.request.*`).  
  - [ ] Set up alerts on fulfillment failures or delays.  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for shipping service & fulfillment job.  
  - [ ] Playwright tests verifying checkout options + tracking display.  
  - [ ] Manual regression for fallback when integration disabled.

## Dev Notes
### Data Models
- `orders` include shippingInfo, status history; extend with tracking IDs/events.  
  `[Source: architecture.md#5-Data-Architecture]`

### API & Service Specs
- Fulfillment pipeline described in architecture; integrate with shipping provider via Cloud Functions/Run.  
  `[Source: architecture-brownfield.md#5.2-Backend-Services]`

### Component Specs
- Checkout UI must display rate options; order detail pages show tracking timeline.  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Locations & Project Structure
- Shipping service in `src/features/orders/server/shipping-service.ts`.  
  `[Source: architecture.md#4-Application-Architecture]`
- Fulfillment job logic in queue handler (reuse queue from Story 2.5).  
  `[Source: architecture.md#7.2-Infrastructure-Changes]`

### Testing Requirements
- Emulator/mocked tests for shipping provider; integration tests for UI.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Feature flag must allow disabling logistics integration.  
  `[Source: architecture.md#Next-Steps]`
- Ensure compliance with shipping provider requirements (address validation, rate limits).  
  `[Source: prd.md#5.4-Commerce-&-Fulfillment]`

## Testing
- Jest tests for shipping service & fulfillment job. `[Source: architecture.md#8-Testing-Strategy]`
- Playwright tests for UI flows. `[Source: architecture.md#8-Testing-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Draft for checkout fulfillment & shipping integration | Bob (scrum-master) |
