
# Story 5.1: Moderation Pipeline Foundation

## Status
Draft

## Story
**As a** trust & safety engineer,
**I want** a reliable moderation pipeline that scans creations and tracks outcomes,
**so that** flagged content is caught before reaching the feed or checkout.

## Acceptance Criteria
1. Implement automatic moderation job triggered on creation publish (or upload), integrating third-party APIs (e.g., Google Content Safety) and internal rule checks, writing results to `moderation_flags` with status (pending/approved/rejected).  
2. Provide admin moderation queue UI listing pending flags, allowing reviewers to approve/reject, add notes, and trigger feed removal or reinstatement as needed.  
3. Update feed and creation services to respect moderation outcomes (approved only visible), logging audit trail for every status change.  
4. Observability logs moderation throughput, false positives, and backlog; alerts when backlog exceeds threshold or API errors occur.  
5. Tests cover automatic moderation integration, admin decisions, feed visibility changes, and regression ensuring manual overrides persisted.

## Tasks / Subtasks
- [ ] Automatic moderation integration (AC: 1)  
  - [ ] Add Cloud Function/job to call moderation APIs on new creation.  
  - [ ] Record results in `moderation_flags`.  
- [ ] Admin queue UI (AC: 2)  
  - [ ] Build `/admin/moderation` interface for reviewers.  
  - [ ] Enable approve/reject with notes, update status.  
- [ ] Feed/creation synchronization (AC: 3)  
  - [ ] Ensure feed service filters based on moderation status (already referenced in Story 1.9).  
  - [ ] Trigger feed updates/reinstatement on status change.  
- [ ] Observability (AC: 4)  
  - [ ] Emit metrics (`moderation.queue.size`, `moderation.api.errors`).  
  - [ ] Set up alerts/dashboard.  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for moderation job, admin actions.  
  - [ ] Playwright tests for admin UI flow.  
  - [ ] Manual regression ensuring feed respects moderation decisions.

## Dev Notes
### Data Models
- `moderation_flags` schema includes reason, status, reviewer notes.  
  `[Source: architecture-brownfield.md#5.3-Data-Model]`

### Services
- Moderation workflow captured in architecture; integrate with feed pipeline.  
  `[Source: architecture-brownfield.md#6-Workflows]`

### UI
- Admin moderation UI should be efficient, highlight pending tasks.  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Structure
- Moderation logic under `src/features/moderation`; admin UI under `(admin)/moderation`.  
  `[Source: architecture.md#4-Application-Architecture]`

### Testing Requirements
- Unit/integration tests per architecture.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Feature flag to roll out moderation pipeline; ensure audit logs retained.  
  `[Source: architecture.md#Next-Steps]`
- Compliance: store moderation outcomes securely, respect privacy.  
  `[Source: architecture.md#9-Security-Integration]`

## Testing
- Jest tests for moderation automation & admin queue. `[Source: architecture.md#8-Testing-Strategy]`
- Playwright tests for admin moderation UI. `[Source: architecture.md#8-Testing-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Draft for moderation pipeline foundation | Bob (scrum-master) |
