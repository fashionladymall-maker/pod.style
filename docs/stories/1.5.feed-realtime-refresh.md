
# Story 1.5: Feed Real-Time Refresh & Interaction Hooks

## Status
Ready for Review

## Story
**As a** user browsing the Pod.Style feed,
**I want** newly generated or remixed creations to appear promptly without manual reloads,
**so that** I stay engaged with fresh content and see social signals update in near real time.

## Acceptance Criteria
1. Implement a client-side refresh mechanism for the `(feed)` experience that periodically refetches (or subscribes to) new feed entries when the feature flag is enabled, without disrupting the existing legacy homepage.  
2. Integrate a lightweight polling or listener approach that respects Firestore usage limits (e.g., poll every 30 seconds with exponential backoff) and updates the UI with new entries at the top while preserving pagination state.  
3. Update feed services to expose a “since” or cursor endpoint allowing incremental loads; fallback behavior must still function when real-time refresh is disabled.  
4. Emitting metrics/logs for refresh frequency, new item counts, and user interactions resulting from refreshes, ensuring observability dashboards capture these signals.  
5. Tests cover the refetch logic, pagination integrity, and backwards compatibility with legacy `/` when the feature is toggled off.

## Tasks / Subtasks
- [x] Client refresh hook (AC: 1,2)  
  - [x] Add polling mechanism（React hook util）触发定时 refetch，并带指数退避。  
  - [x] Update `FeedScreen` 顶部合并新条目，维持分页状态。  
- [x] Server endpoint support (AC: 3)  
  - [x] Extend feed service to接受 `updatedAfter` 增量加载。  
  - [x] Ensure fallback path returns complete page when incremental data unavailable.  
- [x] Observability (AC: 4)  
  - [x] Emit metrics (`feed.service.refresh.frequency`, `feed.service.refresh.new_items`) 并记录刷新错误。  
  - [x] Document dashboards/alerts for refresh staleness and failures.  
- [x] Feature flag & compatibility (AC: 1,3,5)  
  - [x] Wrap new refresh behavior behind Remote Config/env flag; confirm `/` legacy experience unaffected.  
  - [x] Provide rollback instructions (disable flag, revert to manual refresh).  
- [x] Testing (AC: 5)  
  - [x] Jest tests for polling utilities and service incremental endpoint。  
  - [x] Playwright integration test verifying refresh attribute without breaking pagination。  
  - [x] Manual regression confirming legacy experience unchanged when flag off。

## Dev Notes
### Previous Story Insights
- 1.1 introduced feed route; 1.2–1.4 implemented cache, ranking, and ingestion pipeline.
- This story adds real-time-like refresh for the feed while preserving compatibility.

### Data Models
- No new fields required; rely on timestamps (`updatedAt`) and ranking signals added previously.  
  `[Source: architecture.md#5-data-architecture]`

### API & Service Specifications
- Feed service should support incremental fetch (since timestamp/cursor) to power refresh.  
  `[Source: architecture.md#4-application-architecture]`
- Cloud Function ingestion already updates cache entries; refresh simply consumes those updates.  
  `[Source: architecture-brownfield.md#6-workflows]`

### Component Specifications
- Client `FeedScreen` handles new entries gracefully, preserving scroll/pagination state.  
  `[Source: architecture.md#3-business-user-experience-architecture]`

### File Locations & Project Structure
- Client logic under `src/components/screens/feed-screen.tsx` or dedicated hook `src/features/feed/hooks/useFeedRefresh.ts`.  
  `[Source: architecture.md#41-components--responsibilities]`
- Service updates under `src/features/feed/server/feed-service.ts`.  
  `[Source: architecture.md#4-application-architecture]`

### Testing Requirements
- Unit tests: polling hook, incremental service logic (`src/features/feed/__tests__/use-feed-refresh.test.ts`).  
  `[Source: architecture.md#8-testing-strategy]`
- Integration: Playwright verifying `/beta` auto-refresh vs legacy `/`.  
  `[Source: architecture.md#8-testing-strategy]`

### Technical Constraints
- Feature flag gating remains; refresh behavior should be disabled when flag off.  
  `[Source: architecture.md#11-next-steps]`
- Respect Firestore quotas; polling frequency/backoff must prevent excessive reads.  
  `[Source: architecture-brownfield.md#8-performance--scalability]`
- Observability metrics integrate with prior feed telemetry.  
  `[Source: architecture.md#74-observability]`

## Testing
- Jest unit tests for polling scheduler 与增量服务。 `[Source: architecture.md#8-testing-strategy]`
- Playwright integration test 验证 `/beta` 启用刷新时属性存在且分页正常。 `[Source: architecture.md#8-testing-strategy]`
- Manual regression：关闭 flag 时确认 legacy `/` 体验不变。 `[Source: architecture.md#73-deployment-strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Initial draft for real-time feed refresh | Bob (scrum-master) |
| 2025-03-02 | v0.2 | 实现增量刷新、轮询钩子与指标记录 | James (dev) |

## QA Results

### Review Date: 2025-09-28
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 锚点 slug 未统一（尤其含大写、数字小数点的章节），状态仍为 `Draft`。

#### Test Strategy & Coverage
- 暂未实现，未审查测试。

#### NFR Assessment
- Not assessed。

#### Issues
1. 需修复下列引用：
   - `architecture.md#5-data-architecture` → `architecture.md#5-data-architecture`
   - `architecture.md#4-application-architecture` → `architecture.md#4-application-architecture`
   - `architecture-brownfield.md#6-workflows` → `architecture-brownfield.md#6-workflows`
   - `architecture.md#3-business-user-experience-architecture` → `architecture.md#3-business-user-experience-architecture`
   - `architecture.md#41-components--responsibilities` → `architecture.md#41-components--responsibilities`
   - `architecture.md#4-application-architecture` (重复引用，保持 slug 一致)
   - `architecture.md#8-testing-strategy` (已符合)
   - `architecture.md#11-next-steps` → `architecture.md#11-next-steps`
   - `architecture-brownfield.md#8-performance--scalability` → `architecture-brownfield.md#8-performance--scalability`
   - `architecture.md#74-observability` → `architecture.md#74-observability`
   - `architecture.md#73-deployment-strategy` → `architecture.md#73-deployment-strategy`
2. 状态从 `Draft` 改为 `Ready`。`docs/stories/1.5.feed-realtime-refresh.md:4`

#### Recommendations
- 统一锚点与状态后再提交回审。

#### Suggested Status
- Changes Required

### Review Date: 2025-09-28 (二次复核)
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- `[Source: ...]` 引用已全部转为合法 slug，并确认故事状态为 `Ready`；刷新策略说明与旗标控制清晰。

#### Test Strategy & Coverage
- 仍在规划阶段，等待真实实现。

#### NFR Assessment
- Not assessed。

#### Issues
- None.

#### Recommendations
- 实现轮训/监听逻辑时，记得记录真实请求频率并验证 Firestore 配额阈值。

#### Suggested Status
- Pass

## Dev Agent Record
### Agent Model Used
- James (GPT-5)

### Debug Log References
- `npm run lint`
- `npm run typecheck`
- `npm run test -- feed-service`
- `npm run test -- feed-ingestion`
- `npm run test -- feed-ranking`
- `npm run test -- use-feed-refresh`

### Completion Notes List
- 增量接口新增 `updatedAfter` 支持并记录刷新指标/缓存命中率。
- 客户端引入 `useFeedRefresh` 轮询钩子与 flag 驱动 UI 刷新。
- 更新文档 & 测试（Playwright + Jest），涵盖刷新回滚与观测面板。

### File List
- src/features/feed/config.ts
- src/features/feed/server/feed-service.ts
- src/features/feed/server/actions.ts
- src/features/feed/hooks/use-feed-refresh.ts
- src/features/feed/__tests__/feed-service.test.ts
- src/features/feed/__tests__/use-feed-refresh.test.tsx
- src/components/screens/feed-screen.tsx
- src/app/feed-page.tsx
- tests/integration/feed.spec.ts
- .env.example
- DEPLOYMENT_GUIDE.md
- docs/architecture.md
- docs/stories/1.5.feed-realtime-refresh.md
