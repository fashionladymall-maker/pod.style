
# Story 1.8: Feed Backfill & Migration

## Status
Ready

## Story
**As a** platform operator,
**I want** to backfill existing creations into the new feed cache and migrate legacy data without downtime,
**so that** users immediately see rich feed content when the new experience launches.

## Acceptance Criteria
1. Provide a backfill script or Cloud Function job that scans existing `creations` documents, computes ranking signals, and populates `personalized_feed_cache` / `feed_entries` with default values while respecting rate limits.  
2. Migration tooling must be idempotent, resumable, and able to run in batches to avoid hitting Firestore quotas; failures logged with actionable errors.  
3. Rollout strategy includes a “backfill complete” check, linking to dashboards/metrics verifying coverage before enabling the new feed flag for all users.  
4. Regression/sanity checks confirm legacy pages continue to function during backfill (no data corruption or downtime).  
5. Testing covers backfill scripts (e.g., emulator tests), migration dry-run scenarios, and rollback instructions.

## Tasks / Subtasks
- [ ] Backfill implementation (AC: 1,2)  
  - [ ] Implement script/Function to iterate `creations`, calculate ranking defaults, write to cache collections.  
  - [ ] Support pagination/batching to respect Firestore limits; log progress and errors.  
- [ ] Idempotency & resilience (AC: 2)  
  - [ ] Ensure reruns skip existing entries or update as needed without duplication.  
  - [ ] Capture failure logs with actionable details; provide resume capability.  
- [ ] Rollout readiness (AC: 3)  
  - [ ] Document steps to verify backfill completion (metrics, dashboard checks).  
  - [ ] Gate new feed rollout until verification passes.  
- [ ] Regression/compatibility (AC: 4)  
  - [ ] Run regression tests ensuring legacy `/` remains operational during backfill.  
  - [ ] Include manual checklist for verifying data integrity.  
- [ ] Testing & rollback (AC: 5)  
  - [ ] Emulator tests simulating backfill.  
  - [ ] Document rollback procedure (e.g., remove new fields, disable flag).  

## Dev Notes
### Previous Story Insights
- Build on ingestion pipeline (Story 1.4) and experiments (1.7) to ensure data layers ready before GA rollout.

### Data Models
- Use `rankingSignals`, `region`, `personaVector`, etc., as defined; ensure defaults when not present.  
  `[Source: architecture.md#5-data-architecture]`

### API & Service Specifications
- The backfill interacts with the same collections consumed by feed service; align with ingestion pipeline to avoid conflicting writes.  
  `[Source: architecture.md#4-application-architecture]`

### Component Specifications
- No UI change; ensure operations tooling/CLI accessible to run backfill.  
  `[Source: architecture-brownfield.md#10-migration--rollout-strategy]`

### File Locations & Project Structure
- Scripts placed under `scripts/feed/` or Cloud Function within `functions/` depending on approach.  
  `[Source: architecture.md#41-components--responsibilities]`

### Testing Requirements
- Emulator tests for batch backfill; manual dry-run instructions for staging.  
  `[Source: architecture.md#8-testing-strategy]`

### Technical Constraints
- Respect Firestore quotas and maintain optional fields compatibility.  
  `[Source: architecture.md#2-Enhancement-Scope-and-Integration-Strategy]`
- Provide monitoring to detect incomplete backfill.  
  `[Source: architecture.md#74-observability]`

## Testing
- Emulator tests for backfill tool. `[Source: architecture.md#8-testing-strategy]`
- Manual dry-run and regression plan documented. `[Source: architecture.md#73-deployment-strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Initial backfill & migration story draft | Bob (scrum-master) |

## QA Results

### Review Date: 2025-09-28
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 锚点仍需规范化，状态未更新。

#### Test Strategy & Coverage
- 未评估测试。

#### NFR Assessment
- Not assessed。

#### Issues
1. 修正以下引用：
   - `architecture.md#5-data-architecture` → `architecture.md#5-data-architecture`
   - `architecture.md#4-application-architecture` → `architecture.md#4-application-architecture`
   - `architecture-brownfield.md#10-migration--rollout-strategy` → `architecture-brownfield.md#10-migration--rollout-strategy`
   - `architecture.md#41-components--responsibilities` → `architecture.md#41-components--responsibilities`
   - `architecture.md#8-testing-strategy` (保持)
   - `architecture.md#2-Enhancement-Scope-and-Integration-Strategy` (保持)
   - `architecture.md#74-observability` → `architecture.md#74-observability`
   - `architecture.md#73-deployment-strategy` → `architecture.md#73-deployment-strategy`
2. Story 状态应改为 `Ready`。`docs/stories/1.8.feed-backfill-and-migration.md:4`

#### Recommendations
- 完成锚点修复并更新状态后，再提交复审。

#### Suggested Status
- Changes Required

### Review Date: 2025-09-28 (二次复核)
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 文档锚点已规范化且状态设为 `Ready`，回填步骤及监控检查点清楚。

#### Test Strategy & Coverage
- 等待回填脚本落地，本次不评估测试。

#### NFR Assessment
- Not assessed。

#### Issues
- None.

#### Recommendations
- 执行批量回填时，记录批处理速率/失败指标，并验证 rollback 指引覆盖数据清理。

#### Suggested Status
- Pass
