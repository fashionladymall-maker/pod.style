
# Story 1.4: Feed Entry Ingestion Pipeline

## Status
Ready for Review

## Story
**As a** platform operator managing Pod.Style content,
**I want** creation publish events to populate `personalized_feed_cache` and `feed_entries` with the latest ranking signals,
**so that** the new feed experience always serves fresh, curated data without manual intervention.

## Acceptance Criteria
1. Cloud Function `updatePersonalizedFeedCache` (or an extended companion function) listens to creation publish events, builds feed documents enriched with engagement defaults, personalization placeholders, and writes to `personalized_feed_cache` / `feed_entries` collections while leaving existing functionality intact.  
2. The ingestion pipeline normalizes required fields (`region`, `personaVector`, `rankingSignals`, `updatedAt`) and ensures backward-compatible writes that legacy readers can consume.  
3. The pipeline emits events/metrics when feed entries are created or updated, including failure alerts, and supports reprocessing triggered via an admin command or scheduled job.  
4. Integration tests confirm that publishing a creation (in emulator) results in feed cache entries being created and available to Stories 1.1–1.3 services without affecting legacy pathways.  
5. Rollout plan includes feature flag / Remote Config gating for the new pipeline, plus documented rollback procedure.

## Tasks / Subtasks
- [x] Pipeline design & setup (AC: 1,2)  
  - [x] Extend or wrap `updatePersonalizedFeedCache` Cloud Function to populate new fields (`rankingSignals`, `personaVector`, etc.) using default values.  
  - [x] Ensure writes target both `personalized_feed_cache` and `feed_entries` with denormalized data.  
- [x] Backward compatibility safeguards (AC: 2)  
  - [x] Validate that legacy readers ignore new fields; add unit tests or emulator checks.  
  - [x] Provide backfill script/instructions for existing documents.  
- [x] Reprocessing & observability (AC: 3)  
  - [x] Emit `feed.ingestion.success/failure` metrics and log errors with actionable context.  
  - [x] Implement admin-triggered reprocess (CLI or callable) to refresh cache entries.  
- [x] Testing (AC: 4)  
  - [x] Emulator-based integration test: publishing a creation triggers feed cache update and makes entry available to feed service.  
  - [x] Unit tests covering new transformation logic.
- [x] Rollout & rollback (AC: 5)  
  - [x] Add feature flag / Remote Config switch to toggle new ingestion path.  
  - [x] Document rollback plan (disable flag, purge new fields if needed) in deployment guide.

## Dev Notes
### Previous Story Insights
- Stories 1.1–1.3 created feed route, caching, and ranking logic; they rely on populated cache entries.

### Data Models
- `personalized_feed_cache` and `feed_entries` hold denormalized feed data with optional ranking/per personalization fields.  
  `[Source: architecture.md#5-data-architecture]`
- Engagement counters originate from `creations`; defaults should be zero/empty when publishing.  
  `[Source: architecture-brownfield.md#53-data-model]`

### API & Service Specifications
- Feed service expects cache entries to be ready; ingestion pipeline should orchestrate data flow from creation events.  
  `[Source: architecture.md#4-application-architecture]`
- Cloud Function currently refreshes cache periodically; extend without breaking schedule.  
  `[Source: architecture-brownfield.md#52-backend-services]`

### Component Specifications
- No UI change; ensure admin tools can trigger reprocess if needed (document CLI/API).  
  `[Source: architecture.md#3-business-user-experience-architecture]`

### File Locations & Project Structure
- Cloud Function code under `functions/` (or `src/server` if consolidated) should follow existing structure.  
  `[Source: architecture-brownfield.md#52-backend-services]`
- Backfill scripts/config placed in `scripts/` or `docs/` as per project conventions.  
  `[Source: architecture.md#41-components--responsibilities]`

### Testing Requirements
- Emulator tests for Firestore triggers ensure new documents appear and optional fields handled.  `[Source: architecture.md#8-testing-strategy]`
- Integration tests verifying feed service gets freshly ingested entries.  `[Source: architecture.md#8-testing-strategy]`

### Technical Constraints
- Writes must be idempotent, safe for retries, and not break legacy data readers.  
  `[Source: architecture.md#2-Enhancement-Scope-and-Integration-Strategy]`
- Maintain feature flag gating to control rollout; rollback doc required.  
  `[Source: architecture-brownfield.md#10-migration--rollout-strategy]`
- Observability metrics must integrate with existing logging/alerts.  
  `[Source: architecture.md#74-observability]`

## Testing
- Jest unit tests覆盖 ingestion transformation（成功/失败场景）。 `[Source: architecture.md#8-testing-strategy]`
- Jest 集成测试（stubbed Firestore）验证 creation -> cache entry pipeline。 `[Source: architecture.md#8-testing-strategy]`
- Playwright `/beta` 检查 & 手动回归确保 legacy feed 不受影响。 `[Source: architecture.md#73-deployment-strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Initial draft covering feed ingestion pipeline | Bob (scrum-master) |
| 2025-03-02 | v0.2 | 实现 ingestion pipeline、回填脚本与监控指标 | James (dev) |

## QA Results

### Review Date: 2025-09-28
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 同样存在多处 `[Source: ...]` 锚点未转成 Markdown slug，且故事仍标记为 `Draft`。

#### Test Strategy & Coverage
- 未进入实现，暂不评估测试。

#### NFR Assessment
- Not assessed。

#### Issues
1. 修正以下锚点：
   - `architecture.md#5-data-architecture` → `architecture.md#5-data-architecture`
   - `architecture-brownfield.md#53-data-model` → `architecture-brownfield.md#53-data-model`
   - `architecture.md#4-application-architecture` → `architecture.md#4-application-architecture`
   - `architecture-brownfield.md#52-backend-services` → `architecture-brownfield.md#52-backend-services`
   - `architecture.md#3-business-user-experience-architecture` → `architecture.md#3-business-user-experience-architecture`
   - `architecture.md#41-components--responsibilities` → `architecture.md#41-components--responsibilities`
   - `architecture.md#8-testing-strategy` (保持现状即可)
   - `architecture.md#2-Enhancement-Scope-and-Integration-Strategy` (保持现状即可)
   - `architecture-brownfield.md#10-migration--rollout-strategy` → `architecture-brownfield.md#10-migration--rollout-strategy`
   - `architecture.md#74-observability` → `architecture.md#74-observability`
   - `architecture.md#73-deployment-strategy` → `architecture.md#73-deployment-strategy`
2. `Status` 应更新为 `Ready`。`docs/stories/1.4.feed-entry-ingestion.md:4`

#### Recommendations
- 统一锚点格式；完成后调整状态。

#### Suggested Status
- Changes Required

### Review Date: 2025-09-28 (二次复核)
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 所有引用锚点已统一，文档状态更新为 `Ready`；数据流与回滚说明清晰可追踪。

#### Test Strategy & Coverage
- 暂无实现代码，等待 pipelines 开发。

#### NFR Assessment
- Not assessed。

#### Issues
- None.

#### Recommendations
- 开发时注意回放脚本的幂等性，并将成功/失败指标接入现有监控面板。

#### Suggested Status
- Pass

## Dev Agent Record
### Agent Model Used
- James (GPT-5)

### Debug Log References
- `npm run lint`
- `npm run typecheck`
- `npm run test -- feed-service`
- `npm run test -- feed-ranking`
- `npm run test -- feed-ingestion`

### Completion Notes List
- 新增 `feed-ingestion` helper，统一排名计算并输出标准化缓存/Feed Entry 文档。
- 扩展 `updatePersonalizedFeedCache`，在特性开关启用时写入 `personalized_feed_cache` 与 `feed_entries` 并记录成功/失败指标；保留 legacy 路径。
- 暴露 `reprocessFeedCache` HTTP 入口、更新部署指南、提供回滚流程，并补充 Jest/Playwright 覆盖。

### File List
- functions/feed-ingestion.js
- functions/index.js
- src/features/feed/config.ts
- src/features/feed/server/feed-service.ts
- src/features/feed/server/ranking.ts
- src/features/feed/__tests__/feed-service.test.ts
- src/features/feed/__tests__/feed-ranking.test.ts
- src/features/feed/__tests__/feed-ingestion.test.ts
- src/components/screens/feed-screen.tsx
- src/components/screens/home-screen.tsx
- src/features/creations/server/creation-repository.ts
- src/features/orders/server/order-repository.ts
- src/app/api/image-proxy/route.ts
- tests/integration/feed.spec.ts
- .env.example
- DEPLOYMENT_GUIDE.md
- docs/architecture.md
- docs/stories/1.4.feed-entry-ingestion.md
