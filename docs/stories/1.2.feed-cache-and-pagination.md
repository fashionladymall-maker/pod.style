
# Story 1.2: Feed Cache & Pagination Service

## Status
Ready for Review

## Story
**As a** browsing user consuming the Pod.Style feed,
**I want** the feed service to paginate using personalized cache entries with graceful fallbacks and instrumentation,
**so that** I can scroll reliably while the system captures ranking signals and preserves existing behavior.

## Acceptance Criteria
1. `src/features/feed/server/feed-service.ts` implements `fetchInitialFeed` and `fetchMoreFeed` that first read `personalized_feed_cache` (filtered by region/language) and fall back to legacy public creations with deterministic ordering; both functions return typed responses consumed by Story 1.1’s server actions.  
2. The service logs latency and cache-hit metrics using the standardized logger namespace and ensures metrics appear in observability dashboards.  
3. Cursor-based pagination uses Firestore queries compatible with new fields (`region`, `personaVector`, `rankingSignals`), tolerating missing fields without runtime failures.  
4. Feature flag for the new feed remains configurable; legacy homepage and existing `getPublicCreations` API continue working when the flag is disabled.  
5. Integration tests (Playwright or equivalent) validate that `/beta` renders paginated feed results while `/` remains unaffected when the flag is off.

## Tasks / Subtasks
- [x] Extend feed service data layer (AC: 1,3)  
  - [x] Implement `fetchInitialFeed`/`fetchMoreFeed` using Firestore queries against `personalized_feed_cache` with region/language filters.  
  - [x] Add fallback query to `creations` with stable ordering when cache is empty.  
- [x] Metrics & observability (AC: 2)  
  - [x] Hook into logging utilities to emit latency + cache-hit metrics (`feed.service.latency`, `feed.service.cacheHit`).  
  - [x] Document dashboards/alerts expectations for SRE handoff.  
- [x] Pagination contract integration (AC: 1,3)  
  - [x] Update server actions to delegate pagination to the new service functions with typed cursors.  
  - [x] Ensure Firestore queries tolerate missing optional fields and log warnings only in non-critical cases.  
- [x] Feature flag sanity (AC: 4)  
  - [x] Verify `/beta` gating via Remote Config/env toggle; write rollout note describing on/off procedure.  
  - [x] Confirm legacy `/` continues to use existing `AppClient`.  
- [x] Testing (AC: 5)  
  - [x] Jest unit tests for feed service covering cache hit, fallback, and cursor pagination.  
  - [x] Playwright integration test ensuring `/beta` page paginates without affecting legacy `/`.  

## Dev Notes
### Previous Story Insights
- 1.1 created `(feed)` route, FeedScreen component, and initial server actions scaffolding with feature flag gating.
- This story deepens service logic while respecting the same feature flag and legacy fallback.

### Data Models
- `personalized_feed_cache` documents include optional fields `region`, `personaVector`, `updatedAt`, `rankingSignals`; service must read gracefully even if fields are missing.  
  `[Source: architecture.md#2-enhancement-scope-and-integration-strategy]`
- `creations` remains the canonical source for public entries and should maintain compatibility.  
  `[Source: architecture.md#5-data-architecture]`

### API & Service Specifications
- Feed service handles aggregation/pagination and gets triggered by Cloud Function updates.  
  `[Source: architecture.md#4-application-architecture]`
- Cloud Function `updatePersonalizedFeedCache` writes `personalized_feed_cache`; service should align with its structure without modifying the function yet.  
  `[Source: architecture-brownfield.md#5.2-Backend-Services]`

### Component Specifications
- Client FeedScreen (Story 1.1) already renders props; ensure pagination props align with new service return shape.  
  `[Source: architecture.md#3-business-user-experience-architecture]`
- Do not change legacy `/` layout; feature flag continues to guard beta experience.  
  `[Source: architecture.md#11-next-steps]`

### File Locations & Project Structure
- Service logic in `src/features/feed/server/feed-service.ts`; server actions in `src/features/feed/server/actions.ts`.  
  `[Source: architecture.md#41-components--responsibilities]`
- Integration tests placed under `tests/integration/feed.spec.ts`; unit tests under `src/features/feed/__tests__`.  
  `[Source: architecture.md#8-testing-strategy]`

### Testing Requirements
- Unit tests covering cache hit, fallback, cursor.  `[Source: architecture.md#8-testing-strategy]`
- Playwright integration verifying pagination + feature flag behavior.  `[Source: architecture.md#8-testing-strategy]`
- Regression check confirming legacy `/` unaffected.  `[Source: architecture.md#73-deployment-strategy]`

### Technical Constraints
- Maintain backward-compatible Firestore schema; optional fields must not break existing readers.  
  `[Source: architecture.md#2-enhancement-scope-and-integration-strategy]`
- Continue instrumentation and feature flag plan introduced in Story 1.1.  
  `[Source: architecture.md#74-observability]`

## Testing
- Jest unit tests for feed service (cache hit/fallback/cursor). `[Source: architecture.md#8-testing-strategy]`
- Playwright integration test for `/beta` pagination and legacy `/` fallback. `[Source: architecture.md#8-testing-strategy]`
- Manual check for metrics emission and feature toggle behavior. `[Source: architecture.md#74-observability]`
- Current automated coverage: `npm run test -- feed-service`; Playwright scenario (`tests/integration/feed.spec.ts`) requires `FEED_E2E_BASE_URL` and optional `FEED_E2E_EXPECT_BETA` environment variables to execute against a running app instance.

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Initial draft building on Story 1.1 feed foundation | Bob (scrum-master) |
| 2025-03-02 | v0.2 | Implemented cache-first pagination, instrumentation, and Jest coverage | James (dev) |

## QA Results

### Review Date: 2025-09-28
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 文档结构完整，但仍保留与架构文档 anchor 不匹配的引用，影响可读性与后续开发引用效率。

#### Test Strategy & Coverage
- 尚未进入实现阶段，本次检查只聚焦文档准备情况。

#### NFR Assessment
- Not assessed。

#### Issues
1. `[Source: architecture.md#Next-Steps]` 未按 Markdown 规则生成 slug，应改为 `architecture.md#11-next-steps` 以确保导航可用。`docs/stories/1.2.feed-cache-and-pagination.md:57`
2. Story `Status` 仍为 `Draft`。若 SM/PO 已确认 ready，应更新为 `Ready`，方便流程推进。`docs/stories/1.2.feed-cache-and-pagination.md:4`

#### Recommendations
- 更新上述 anchor，确认页面渲染后可正确跳转。
- 修正 Story 状态以匹配当前准备度。

#### Suggested Status
- Changes Required

### Review Date: 2025-09-28 (二次复核)
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 已确认所有 `[Source: ...]` 链接锚点符合 Markdown slug 规则，跳转正常；故事状态也已更新为 `Ready`。

#### Test Strategy & Coverage
- 仍属规划阶段，无代码改动或测试需求。

#### NFR Assessment
- Not assessed。

#### Issues
- None.

#### Recommendations
- 可以进入实现阶段；开发时请对分页、缓存命中率、遥测指标进行验证。

#### Suggested Status
- Pass
