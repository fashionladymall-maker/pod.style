# Story 1.1: Feed Discovery Foundation

## Status
Ready for Review

## Story
**As a** guest or returning creator browsing Pod.Style,
**I want** to access a dedicated feed experience that loads curated creations quickly from modular services,
**so that** I can explore trending content without being blocked by legacy page structure.

## Acceptance Criteria
1. A new Next.js route group `(feed)` exposes a server-rendered landing page that retrieves at least 10 feed entries via a dedicated feed server action while keeping the current `/` experience unchanged behind a feature flag.  
2. `src/features/feed/server/actions.ts` provides typed server actions for initial feed load and cursor-based pagination that read from `personalized_feed_cache` when entries exist and fall back to public creations data without runtime errors.  
3. Feed data access is centralized in `src/features/feed/server/feed-service.ts` (or equivalent) with Firestore queries constrained to configurable region/language parameters, respecting optional new fields `region`, `personaVector`, and `rankingSignals`.  
4. The build introduces Remote Config (or env-driven) gating so the new feed can be enabled for `/beta` traffic without affecting the current homepage, and includes telemetry hooks to log feed latency metrics.

## Tasks / Subtasks
- [x] Establish feed module scaffolding (AC: 1,2)  
  - [x] Create `src/features/feed/server/feed-service.ts` with functions for initial load and paginated fetch referencing Firestore `creations` / `personalized_feed_cache`.  
  - [x] Add `src/features/feed/server/actions.ts` exporting server actions that call the service with Zod-validated inputs.  
- [x] Implement Next.js feed route (AC: 1)  
  - [x] Add `(feed)/layout.tsx` and `(feed)/page.tsx` using existing providers (`AuthProvider`, `Toaster`) and rendering a new `FeedScreen` component.  
  - [x] Create `src/components/screens/feed-screen.tsx` consuming server-provided props and handling client pagination.  
- [x] Configure feature flag + legacy fallback (AC: 1,4)  
  - [x] Add configuration to toggle feed route exposure (e.g., `NEXT_PUBLIC_ENABLE_FEED_BETA` + Remote Config note) and document rollout steps.  
  - [x] Ensure `/` retains current `AppClient` while `/beta` rewrites to new feed when flag enabled.  
- [x] Data access & caching rules (AC: 2,3)  
  - [x] Query `personalized_feed_cache` for current user/locale; implement fallback to `getPublicCreations` on empty results.  
  - [x] Model Firestore query constraints for optional fields (`region`, `rankingSignals`) and prepare typed responses.  
- [x] Observability & testing (AC: 4)  
  - [x] Emit feed latency metric via existing logging utilities and document expected dashboard hook.  
  - [x] Add Jest unit tests for feed service (success + fallback cases) and integration test stub exercising `(feed)` page rendering.  

## Dev Notes
### Previous Story Insights
- No earlier stories; this is the foundation for the feed epic.

### Data Models
- `personalized_feed_cache` entries require extension fields `region`, `personaVector`, `updatedAt`, and `rankingSignals`; service should tolerate missing fields while preparing for future population.  
  `[Source: architecture.md#2-enhancement-scope-and-integration-strategy]`
- Legacy `creations` collection remains the fallback data source and must remain read-compatible.  
  `[Source: architecture.md#5-data-architecture]`

### API & Service Specifications
- Introduce `feed-service` as described, responsible for aggregation, pagination, and cache refresh triggers.  
  `[Source: architecture.md#4-application-architecture]`
- Cloud Function `updatePersonalizedFeedCache` currently writes trending data; service should align with its document shape and avoid altering scheduler behavior.  
  `[Source: architecture-brownfield.md#52-backend-services]`

### Component Specifications
- New modular feed UI should reside in `src/components/screens/feed-screen.tsx`, leveraging existing Tailwind/Radix primitives to match design guidelines.  
  `[Source: architecture.md#3-business-user-experience-architecture]`
- Maintain legacy `AppClient` for `/` while offering `/beta` entry point; do not delete existing screens yet.  
  `[Source: architecture.md#11-next-steps]`

### File Locations & Project Structure
- Feature code belongs under `src/features/feed` (service/actions/repository pattern).  
  `[Source: architecture.md#41-components--responsibilities]`
- Route group: `src/app/(feed)/page.tsx` (Server Component) with supporting layout/client transitions.  
  `[Source: architecture.md#4-application-architecture]`
- Configuration/feature flag documentation should live in `docs/architecture.md` change log after implementation.

### Testing Requirements
- Unit tests: Jest + ts-jest, located in `src/features/feed/__tests__/feed-service.test.ts`, covering cached vs fallback paths.  
  `[Source: architecture.md#8-testing-strategy]`
- Integration: Add Playwright (or emulator) scenario ensuring `/beta` renders feed data without impacting `/`. Place under `tests/integration/feed.spec.ts`.  
  `[Source: architecture.md#8-testing-strategy]`
- Regression: Update smoke checklist to include feed load + legacy page check.  
  `[Source: architecture.md#8-testing-strategy]`

### Technical Constraints
- Ensure all new Firestore reads maintain backward compatibility: new fields must be optional and typed defensively.  
  `[Source: architecture.md#2-enhancement-scope-and-integration-strategy]`
- Implement feature gating so rollout can be controlled via `/beta` rewrite and Remote Config toggles.  
  `[Source: architecture-brownfield.md#10-migration--rollout-strategy]`
- Instrument feed latency and success metrics for observability dashboards.  
  `[Source: architecture.md#74-observability]`

## Testing
- Jest unit tests for feed service (cache + fallback).  `[Source: architecture.md#8-testing-strategy]`
- Playwright integration test ensuring `/beta` feed page renders and pagination works.  `[Source: architecture.md#8-testing-strategy]`
- Manual regression: Verify legacy `/` homepage unaffected when feed flag disabled.  `[Source: architecture.md#73-deployment-strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Initial draft created from PRD/architecture references | Bob (scrum-master) |

## Dev Agent Record
### Agent Model Used
- James (GPT-5)

### Debug Log References
- `npm run lint`

### Completion Notes List
- 实现 feed 服务层（缓存优先、公共作品回退）并输出性能日志。
- 新建 Next.js `(feed)` 路由、`FeedScreen` 客户端组件与 `/beta` 入口，受环境变量开关控制。
- 追加 Jest 单元测试与 Playwright 集成测试占位，确保分页逻辑可回归。

### File List
- src/app/(feed)/layout.tsx
- src/app/(feed)/page.tsx
- src/app/(feed)/beta/page.tsx
- src/app/(legacy)/page.tsx
- src/app/page.tsx
- src/components/screens/feed-screen.tsx
- src/features/feed/config.ts
- src/features/feed/server/actions.ts
- src/features/feed/server/feed-service.ts
- src/features/feed/__tests__/feed-service.test.ts
- src/server/actions/index.ts
- tests/integration/feed.spec.ts
## QA Results

### Review Date: 2025-09-28
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 当前故事仍处文档阶段，主要检查引用、锚点与流程完整性。

#### Test Strategy & Coverage
- 尚未进入实现阶段，测试策略未触发；等待开发完成后再做覆盖验证。

#### NFR Assessment
- Not assessed。本次审核聚焦文档完整性。

#### Issues
1. `docs/stories/1.1.feed-foundation.md` 中所有 `[Source: ...]` 链接锚点依旧保留标题原文（含大写与标点），与渲染后的 Markdown `id` 不匹配，导致点击跳转失败（例如现写为 `architecture.md#2-Enhancement-Scope-and-Integration-Strategy`，应改为 `architecture.md#2-enhancement-scope-and-integration-strategy` 等）。这样会让后续开发快速定位资料时遇到阻碍，必须在提交前修复。
2. 故事 `Status` 仍为 `Draft`。若已完成 SM/PO 的草拟与验证，应更新为 `Ready`，否则其它角色会误以为故事未准备好进入实现。

#### Recommendations
- 调整所有 `[Source: ...]` 链接为小写、用连字符替换空格与标点的 Markdown 锚点；逐一测试确保能正确跳转。
- 在完成引用修复并确认故事内容达标后，将 `Status` 更新为 `Ready`，再推进到开发流程。

#### Suggested Status
- Changes Required

### Review Date: 2025-09-28 (二次复核)
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 已逐一检查所有 `[Source: ...]` 引用锚点，均改为符合 Markdown 规则的 slug，可正常跳转定位对应章节。

#### Test Strategy & Coverage
- 仍属规划阶段，无代码改动或测试需求。

#### NFR Assessment
- Not assessed。

#### Issues
- 无新增问题，上一轮指出的锚点错误已修复。

#### Recommendations
- Story `Status` 仍为 `Draft`，建议在流程推进前更新为 `Ready`，保持和 PO/SM 流程一致。

#### Suggested Status
- Ready for Done
