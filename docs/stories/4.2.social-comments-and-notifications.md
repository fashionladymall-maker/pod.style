
# Story 4.2: Commenting & Engagement Notifications

## Status
Draft

## Story
**As a** community member,
**I want** to comment on creations and receive notifications when others engage,
**so that** I can participate in discussions and stay informed about activity around my work.

## Acceptance Criteria
1. Implement comment server actions using existing `creations/{id}/comments` collection, validating input, enforcing moderation (no banned content), and updating comment counts/engagement metrics.  
2. UI comment drawer (existing component) integrates with server actions, supporting pagination, optimistic updates, and moderation-safe error handling.  
3. Notification service sends alerts when new comments/replies occur, respecting user preferences and moderation status; feed ranking updates reflect comment engagement signals.  
4. Observability logs comment volume, notification success/failure, and moderation-related removals; dashboards highlight spikes or anomalies.  
5. Tests cover comment creation/deletion, notification triggers, UI flows, and regression ensuring features disabled cleanly when social flag off.

## Tasks / Subtasks
- [ ] Comment actions (AC: 1)  
  - [ ] Implement server actions for add/delete comments with moderation checks.  
  - [ ] Update engagement metrics and rerun feed ranking adjustments.  
- [ ] UI integration (AC: 2)  
  - [ ] Wire `CommentsSheet` to new server actions; handle optimistic updates and errors.  
  - [ ] Support pagination/load more.  
- [ ] Notifications (AC: 3)  
  - [ ] Connect notification pipeline to comment events, respecting user settings/moderation.  
  - [ ] Provide digest or single notifications as defined.  
- [ ] Observability (AC: 4)  
  - [ ] Emit metrics (`social.comment.count`, `social.comment.notification`).  
  - [ ] Document dashboards/alerts.  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for comment actions & moderation fallback.  
  - [ ] Playwright tests for comment UI flow.  
  - [ ] Manual regression when social features disabled.

## Dev Notes
### Data Models
- `creations/{id}/comments` stores comment data; ensure compliance with moderation and Firestore rules.  
  `[Source: architecture.md#5-Data-Architecture]`

### Services
- Notification service integration; feed ranking uses comment signals.  
  `[Source: architecture.md#4-Application-Architecture]`

### UI
- Comments UI already exists; ensure state management and design tokens consistent.  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Locations
- Server actions in `src/features/creations/server/actions.ts`; notification logic in `social-service`.  
  `[Source: architecture.md#4-Application-Architecture]`

### Testing Requirements
- Unit/integration tests per architecture guidance.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Feature flag to disable social features; ensure moderation/notification interplay respects safety rules.  
  `[Source: architecture-brownfield.md#5.5-Moderation-&-Safety]`

## Testing
- Jest/Playwright tests for commenting & notifications. `[Source: architecture.md#8-Testing-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Draft for commenting & engagement notifications | Bob (scrum-master) |
