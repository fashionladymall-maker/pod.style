
# Story 3.5: Order Cancellation & Refund Management

## Status
Draft

## Story
**As a** buyer who changed their mind or encountered an issue,
**I want** to cancel orders within an allowed window and receive refunds promptly,
**so that** I feel confident purchasing custom creations on Pod.Style.

## Acceptance Criteria
1. Provide customer-facing cancellation flow (in orders page) that respects cancellation window (configurable per region/product), updates order status to `Cancelled`, and triggers refund via the appropriate payment provider.  
2. Record refund transactions in `payments` collection (with provider reference, amount, timestamp), ensuring idempotency if the flow is retried.  
3. Notify fulfillment pipeline to halt/shutdown shipments if order is cancelled before Shipped; if already shipped, instruct support to handle manually (log the exception).  
4. Observability logs cancellations/refunds, monitors failure rates, and alerts when refunds fail or exceed thresholds.  
5. Tests cover cancellation constraints, refund processing per provider, observability hooks, and regression with legacy mock checkout when feature flag disabled.

## Tasks / Subtasks
- [ ] Cancellation UI/flow (AC: 1)  
  - [ ] Add cancellation button in order detail with confirmation dialog referencing policy.  
  - [ ] Validate cancellation window and handle errors gracefully.  
- [ ] Refund logic (AC: 2)  
  - [ ] Extend `payments-service` to issue refunds via provider API.  
  - [ ] Record refund entries with idempotent handling.  
- [ ] Fulfillment coordination (AC: 3)  
  - [ ] Update fulfillment queue to stop shipments or log manual escalation if shipped.  
  - [ ] Notify operations/support team of exceptions.  
- [ ] Observability & alerts (AC: 4)  
  - [ ] Log `checkout.refund.*` metrics; configure alerting for failures/excess.  
  - [ ] Document dashboards and escalation steps.  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for cancellation/refund logic.  
  - [ ] Playwright tests for UI flow.  
  - [ ] Manual regression ensuring feature flag fallback.

## Dev Notes
### Data Models
- `payments` should capture refund metadata; `orders` status history must record cancellation event.  
  `[Source: architecture.md#5-Data-Architecture]`

### Services
- Payment service handles provider-specific refunds; ensure security/compliance.  
  `[Source: architecture.md#6-Integration-Architecture]`
- Fulfillment pipeline must respect cancellation signals.  
  `[Source: architecture-brownfield.md#5.2-Backend-Services]`

### UI Considerations
- Cancellation UI must communicate policy (time window, shipping status).  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Structure
- Refund logic under `src/features/payments/server/`; UI in `(shop)/orders`.  
  `[Source: architecture.md#4-Application-Architecture]`

### Testing
- Unit tests for cancellation/refund logic; integration tests for UI.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Feature flag for refund flow; compliance with provider policies.  
  `[Source: architecture.md#Next-Steps]`
- Security: ensure secure handling of refund operations.  
  `[Source: architecture.md#9-Security-Integration]`

## Testing
- Jest/Integration tests for cancellation & refund. `[Source: architecture.md#8-Testing-Strategy]`
- Regression for legacy mock fallback. `[Source: architecture.md#7.3-Deployment-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Draft for order cancellation & refund management | Bob (scrum-master) |
