
# Story 3.1: Checkout Foundation & Stripe Integration

## Status
Draft

## Story
**As a** buyer on Pod.Style,
**I want** a guided checkout experience supported by a real payment provider,
**so that** I can purchase custom creations confidently and securely.

## Acceptance Criteria
1. Create a dedicated `(shop)` route group (e.g., cart/checkout pages) that consumes creation data (selected variant, product options) and renders a responsive checkout form.  
2. Integrate Stripe payment intents via secure server actions (`payments-service`), storing only tokenized data (`payments` collection) and ensuring no raw card data touches Firestore.  
3. Support both guest checkout (email + minimal info) and authenticated user checkout (prefill saved addresses/payments when available).  
4. Implement order creation (`orders` collection) upon successful payment intent confirmation, capturing line items, shipping info, payment summary, and status history.  
5. Observability & testing: log payment attempts/results, provide error feedback, add unit/integration tests covering checkout flow and feature flag fallback.

## Tasks / Subtasks
- [ ] Checkout routes & UI (AC: 1,3)  
  - [ ] Add `(shop)/cart/page.tsx` and `(shop)/checkout/page.tsx` with shared layout.  
  - [ ] Implement forms for shipping + payment, with guest/auth flows.  
- [ ] Stripe integration (AC: 2)  
  - [ ] Create `src/features/payments/server/stripe-service.ts` to handle payment intents.  
  - [ ] Expose server actions for creating/confirming payments.  
- [ ] Order creation (AC: 4)  
  - [ ] Implement order persistence (using `order-service`) upon payment success.  
  - [ ] Link orders to user/guest and include status history.  
- [ ] Observability & error handling (AC: 5)  
  - [ ] Log payment attempts (`checkout.payment.*`), handle errors gracefully, and display user-friendly messages.  
  - [ ] Document rollback procedure (remove tokens, cancel orders).  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for payment/order server actions (mock Stripe).  
  - [ ] Playwright tests for checkout UI (guest/auth flows).  
  - [ ] Manual regression for legacy mock path when flag disabled.

## Dev Notes
### Data Models
- `orders` schema includes paymentSummary, shippingInfo, status history; ensure compatibility with mock flow.  
  `[Source: architecture.md#5-Data-Architecture]`
- `payments` collection stores tokenized info only.  
  `[Source: architecture.md#5-Data-Architecture]`

### API & Service Specs
- Stripe integration as defined; use Cloud Functions/Run if needed for secret handling.  
  `[Source: architecture.md#6-Integration-Architecture]`
- Ensure compliance: no raw card data stored.  
  `[Source: prd.md#Constraints]`

### Component Specs
- Checkout UI must follow design tokens, responsive layout.  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Locations & Project Structure
- Payment logic under `src/features/payments/server/`; checkout UI under `(shop)` and `src/components/screens/checkout-screen.tsx`.  
  `[Source: architecture.md#4.1-Components-&-Responsibilities]`

### Testing Requirements
- Stripe mocking for unit tests; integration tests for UI flow.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Feature flag enabling real Stripe; fallback to mock when disabled.  
  `[Source: architecture.md#Next-Steps]`
- Security: ensure server actions require auth/context where needed.  
  `[Source: architecture.md#9-Security-Integration]`

## Testing
- Jest tests for payment/order logic. `[Source: architecture.md#8-Testing-Strategy]`
- Playwright tests for checkout flow. `[Source: architecture.md#8-Testing-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Checkout foundation & Stripe integration story draft | Bob (scrum-master) |
