
# Story 3.6: Checkout Reconciliation & Backoffice Tools

## Status
Draft

## Story
**As an** operations/finance team member,
**I want** dashboards and backoffice tools to reconcile payments, refunds, and orders,
**so that** I can maintain accurate records and resolve customer issues efficiently.

## Acceptance Criteria
1. Build admin/backoffice views showing recent orders, payment status, refund records, allowing filtering by provider, status, region.  
2. Provide reconciliation exports (CSV/BigQuery queries) summarizing daily payments/refunds, highlighting mismatches between provider and internal records.  
3. Implement audit logs for backoffice actions (manual overrides, refunds, shipment adjustments) and ensure logs are easily accessible.  
4. Observability integrates payments/fulfillment metrics into operations dashboards with alerts for discrepancies or backlog.  
5. Tests cover admin view access, reconciliation export accuracy, audit log integrity, and regression for legacy (mock) checkout when admin tools disabled.

## Tasks / Subtasks
- [ ] Backoffice UI (AC: 1)  
  - [ ] Add admin route (e.g., `/admin/commerce`) displaying order/payment/refund summaries.  
  - [ ] Implement filters & detail views.  
- [ ] Reconciliation exports (AC: 2)  
  - [ ] Create scripts/queries generating daily summaries.  
  - [ ] Document export process for finance.  
- [ ] Audit logging (AC: 3)  
  - [ ] Record admin actions in audit log collection, with metadata (user, action, timestamp).  
  - [ ] Provide UI/CLI to view logs.  
- [ ] Observability (AC: 4)  
  - [ ] Extend dashboards/alerts to cover payment discrepancies and backlog.  
  - [ ] Document escalation procedures.  
- [ ] Testing (AC: 5)  
  - [ ] Playwright tests for admin UI (role-based access).  
  - [ ] Automated checks for export data integrity.  
  - [ ] Manual regression ensuring admin tools hidden when disabled.

## Dev Notes
### Data Models
- Use `orders`, `payments`, audit log collections; ensure consistent schemas.  
  `[Source: architecture.md#5-Data-Architecture]`

### Services
- Admin/backoffice flows described in architecture (commerce operations).  
  `[Source: architecture-brownfield.md#5.2-Backend-Services]`

### UI Considerations
- Admin UI should respect access control; follow design tokens but can be utilitarian.  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Locations
- Admin pages under `(admin)/commerce`; services under `src/features/orders/server/operations-service.ts`.  
  `[Source: architecture.md#4-Application-Architecture]`

### Testing Requirements
- Ensure admin features behind auth/roles; tests for data accuracy.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Feature flags to control rollout; ensure compliance with financial regulations.  
  `[Source: architecture.md#Next-Steps]`
- Security: audit logs immutable; only authorized roles can access.  
  `[Source: architecture.md#9-Security-Integration]`

## Testing
- Playwright tests for admin UI permissions. `[Source: architecture.md#8-Testing-Strategy]`
- Automated checks for reconciliation exports. `[Source: architecture.md#8-Testing-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Draft for checkout reconciliation & backoffice tools | Bob (scrum-master) |
