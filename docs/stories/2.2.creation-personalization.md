
# Story 2.2: Creation Personalization & User Models

## Status
Draft

## Story
**As a** returning creator with unique preferences,
**I want** the creation studio to leverage my personalization model when generating patterns,
**so that** the outputs reflect my style and save iterative prompt tweaking.

## Acceptance Criteria
1. Auto-detect or ensure existence of a `userFineTunedModel` for the authenticated user; if missing, initialize with defaults as described in architecture (strength, tags).  
2. Server actions (`studio-actions`) pass personalization parameters (strength, tags, preferred styles) into Genkit flows (`generateTShirtPatternWithStyle`, `generateModelMockup`) so the generation prompt adjusts accordingly.  
3. Provide UI controls allowing creators to adjust personalization weight and tags before generation, respecting any backend limits.  
4. Logging and observability capture personalization usage (model name, strength applied) for analytics while protecting sensitive data.  
5. Tests confirm personalized generation calls, default initialization when missing, and UI adjustments; ensure fallback to non-personalized flow if feature flag disabled.

## Tasks / Subtasks
- [ ] User model handling (AC: 1)  
  - [ ] Extend studio server actions to call `ensureUserFineTunedModel` (reuse existing service).  
  - [ ] Handle default creation if personalization model missing.  
- [ ] Personalization integration (AC: 2)  
  - [ ] Adjust Genkit flow inputs to include personalization prompts/strength.  
  - [ ] Respect architectureâ€™s personalization rules (tags, styles).  
- [ ] UI controls (AC: 3)  
  - [ ] Add controls (slider/tags) in CreationStudioScreen for personalization adjustments.  
  - [ ] Validate inputs and persist selections across session (optional).  
- [ ] Observability (AC: 4)  
  - [ ] Log personalization usage (`studio.personalization.*`).  
  - [ ] Ensure no sensitive data leaked; document analytics queries.  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for server actions verifying personalized payload.  
  - [ ] Playwright test adjusting personalization slider.  
  - [ ] Manual fallback test when personalization disabled.

## Dev Notes
### Data Models & Context
- `userFineTunedModel` includes strength, tags, preferred styles; defaults provided if not present.  
  `[Source: architecture.md#5-Data-Architecture]`

### API & Service Specs
- `ensureUserFineTunedModel` ensures personalization available; integrate with Genkit flow prompts.  
  `[Source: architecture.md#4-Application-Architecture]`

### Component Specs
- UI should provide user-friendly controls (Radix slider, tag inputs) matching design tokens.  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Locations & Project Structure
- Personalization logic in `src/features/user-models/server/`; studio actions call into it.  
  `[Source: architecture.md#4.1-Components-&-Responsibilities]`
- UI adjustments in `CreationStudioScreen`.  
  `[Source: architecture.md#4-Application-Architecture]`

### Testing Requirements
- Unit/integration tests ensuring personalization path functional.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Feature flag gating (if personalization not ready) must be respected.  
  `[Source: architecture.md#Next-Steps]`
- Ensure prompts avoid leaking user personal data; follow security guidelines.  
  `[Source: architecture.md#9-Security-Integration]`

## Testing
- Jest tests for personalization logic. `[Source: architecture.md#8-Testing-Strategy]`
- Playwright test for UI controls. `[Source: architecture.md#8-Testing-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Personalization integration story draft | Bob (scrum-master) |
