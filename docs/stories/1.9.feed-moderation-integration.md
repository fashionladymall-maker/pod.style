
# Story 1.9: Feed Moderation & Safety Integration

## Status
Ready

## Story
**As a** trust & safety operator,
**I want** the feed to respect moderation decisions and hide inappropriate content promptly,
**so that** users only see compliant creations while moderators can audit changes.

## Acceptance Criteria
1. `feed-service` and ingestion pipeline honor `moderation_flags` and `creations.moderationStatus`, excluding flagged entries from cache/query results while keeping data for audit logs.  
2. When moderation status changes (auto or human), feed cache entries are updated or removed via Cloud Function triggers, and a rollback path allows reinstating content if an appeal succeeds.  
3. Server actions surface minimal moderation metadata (e.g., `isModerated`) for analytics while ensuring no moderated content leaks to users.  
4. Observability captures moderation actions impacting feed (counts of removed/reinstated entries) and alerts when moderation backlog causes stale content.  
5. Tests confirm moderated items disappear from `/beta` feed, cache updates occur on status change, and legacy `/` path remains unaffected.

## Tasks / Subtasks
- [ ] Feed service filtering (AC: 1)  
  - [ ] Update queries to exclude entries with `moderationStatus != approved`.  
  - [ ] Ensure ranking/aggregation respects removed items without errors.  
- [ ] Moderation triggers (AC: 2)  
  - [ ] Cloud Function listening to `moderation_flags` or `creations` updates to refresh/remove cache entries.  
  - [ ] Implement rollback utility to restore entries upon appeal.  
- [ ] Analytics surface (AC: 3,4)  
  - [ ] Server actions expose `isModerated` metadata for analytics only (not user UI).  
  - [ ] Emit metrics/logs for moderation removals and reinstatements; alert when backlog exceeds threshold.  
- [ ] Feature flag & compatibility (AC: 3,5)  
  - [ ] Wrap new behavior behind feed feature flag; legacy path unaffected.  
  - [ ] Document rollback steps (disable triggers/notifiers).  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for filtering logic and moderation update handler.  
  - [ ] Emulator/Playwright tests verifying moderated content removal.  
  - [ ] Manual regression ensuring legacy `/` unaffected.

## Dev Notes
### Previous Story Insights
- Ingestion (1.4) and backfill (1.8) populate feed data; moderation integration ensures compliance.

### Data Models
- `moderation_flags` and `creations.moderationStatus` drive inclusion/exclusion; system must respect audit logs.  
  `[Source: architecture-brownfield.md#53-data-model]`

### API & Service Specifications
- Moderation workflow described in architecture; feed service must integrate with moderation queue/function.  
  `[Source: architecture-brownfield.md#6-workflows]`

### Component Specifications
- No major UI change; ensure admin tooling can see moderation impact, possibly via diagnostics view.  
  `[Source: architecture.md#3-business-user-experience-architecture]`

### File Locations & Project Structure
- Cloud Function updates under `functions/`; feed filtering logic under `src/features/feed/server/`.  
  `[Source: architecture.md#41-components--responsibilities]`

### Testing Requirements
- Emulator tests for function trigger; Playwright verifying moderated items hidden.  
  `[Source: architecture.md#8-testing-strategy]`

### Technical Constraints
- Implementation must be idempotent, maintain audit trail, and avoid deleting data permanently.  
  `[Source: architecture.md#2-Enhancement-Scope-and-Integration-Strategy]`
- Observability metrics integrate with moderation dashboards.  
  `[Source: architecture.md#74-observability]`

## Testing
- Jest unit tests for moderation filtering & triggers. `[Source: architecture.md#8-testing-strategy]`
- Playwright/emulator tests verifying removal behavior. `[Source: architecture.md#8-testing-strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Draft for feed moderation integration | Bob (scrum-master) |

## QA Results

### Review Date: 2025-09-28
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 文档状态尚未更新，锚点 slug 仍需统一。

#### Test Strategy & Coverage
- 未评估。

#### NFR Assessment
- Not assessed。

#### Issues
1. 修复以下锚点：
   - `architecture-brownfield.md#53-data-model` → `architecture-brownfield.md#53-data-model`
   - `architecture-brownfield.md#6-workflows` → `architecture-brownfield.md#6-workflows`
   - `architecture.md#3-business-user-experience-architecture` → `architecture.md#3-business-user-experience-architecture`
   - `architecture.md#41-components--responsibilities` → `architecture.md#41-components--responsibilities`
   - `architecture.md#8-testing-strategy` (无需改)
   - `architecture.md#2-Enhancement-Scope-and-Integration-Strategy` (无需改)
   - `architecture.md#74-observability` → `architecture.md#74-observability`
2. Story `Status` 需改为 `Ready`。`docs/stories/1.9.feed-moderation-integration.md:4`

#### Recommendations
- 完成锚点修正与状态更新后，再次提交 QA。

#### Suggested Status
- Changes Required

### Review Date: 2025-09-28 (二次复核)
### Reviewed By: Quinn (Test Architect)

#### Code Quality Assessment
- 文档引用已标准化，故事状态为 `Ready`；与审核流程的联动说明完整。

#### Test Strategy & Coverage
- 等待后续实现，本轮不评估测试。

#### NFR Assessment
- Not assessed。

#### Issues
- None.

#### Recommendations
- 实现 Cloud Function 触发时需验证审计日志保留与回滚路径，同时确保指标覆盖移除/恢复动作。

#### Suggested Status
- Pass
