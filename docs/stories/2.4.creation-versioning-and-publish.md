
# Story 2.4: Creation Version History & Publish Flow

## Status
Draft

## Story
**As a** creator iterating on designs,
**I want** each generation to be versioned and a clear publish flow to move drafts live,
**so that** I can compare variations, revert if needed, and share finished creations confidently.

## Acceptance Criteria
1. When saving generation results, append entries to a `versions` subcollection (or embedded array) capturing prompt, style, assets, personalization settings, timestamps, and flags for favorites.  
2. Provide UI for viewing version history, selecting a primary variant, and promoting it to “Ready to publish” state; allow reverting to previous versions.  
3. Publishing the selected version updates the main `Creation` document (set `isPublic`, `publishedAt`, etc.), triggers ingestion pipeline (Story 1.4), and enforces moderation pre-check (mark status pending).  
4. Rollback path allows unpublishing (reverting to draft) while retaining version history and optionally cleaning feed entries.  
5. Tests cover version creation/reversion, publish/unpublish transitions, Firestore data integrity, and UI interactions under feature flag control.

## Tasks / Subtasks
- [ ] Version recording (AC: 1)  
  - [ ] Update storage logic to write entries to `creations/{id}/versions` with necessary metadata.  
  - [ ] Ensure data structure aligns with architecture and supports favorites.  
- [ ] Version history UI (AC: 2)  
  - [ ] Add version management UI in CreationStudioScreen (list, select, mark favorite).  
  - [ ] Implement actions to revert/select primary variant.  
- [ ] Publish flow (AC: 3)  
  - [ ] Create publish server action to mark creation public, trigger ingestion, set moderation status.  
  - [ ] Update status/respective fields in Firestore.  
- [ ] Rollback/unpublish (AC: 4)  
  - [ ] Provide action to revert to draft, remove feed entry (if exists), maintain version history.  
  - [ ] Document rollback behavior and logs.  
- [ ] Testing (AC: 5)  
  - [ ] Jest tests for version writes and state transitions.  
  - [ ] Playwright tests for UI flow (view history, publish, revert).  
  - [ ] Manual regression ensuring moderation pipeline invoked correctly.

## Dev Notes
### Data Models
- `versions` structure described in architecture; keep fields consistent (`prompt`, `style`, `patternUri`, `previewPatternUri`, etc.).  
  `[Source: architecture.md#5-Data-Architecture]`
- `Creation` doc fields include `isPublic`, `publishedAt`, `moderationStatus`.  
  `[Source: architecture.md#5-Data-Architecture]`

### API & Service Specs
- Publishing should call ingestion pipeline so feed updates.  
  `[Source: architecture.md#4-Application-Architecture]`
- Moderation pre-check required before final exposure.  
  `[Source: architecture.md#6-Integration-Architecture]`

### Component Specs
- Version UI respects design tokens; actions go through server actions for consistency.  
  `[Source: architecture.md#3-Business-User-Experience-Architecture]`

### File Locations & Project Structure
- Version logic within `creation-service`; server actions in `studio-actions`.  
  `[Source: architecture.md#4-Application-Architecture]`
- UI components in studio screen or dedicated `creation-history` component.  
  `[Source: architecture.md#4.1-Components-&-Responsibilities]`

### Testing Requirements
- Unit/integration tests for version/publish flows; manual regression for ingestion + moderation interplay.  
  `[Source: architecture.md#8-Testing-Strategy]`

### Technical Constraints
- Publishing must be idempotent and safe for retries.  
  `[Source: architecture.md#2-Enhancement-Scope-and-Integration-Strategy]`
- Respect feature flags/moderation checks to avoid unapproved content.  
  `[Source: architecture.md#9-Security-Integration]`

## Testing
- Jest tests for versioning/publish logic. `[Source: architecture.md#8-Testing-Strategy]`
- Playwright tests for version UI and publish flow. `[Source: architecture.md#8-Testing-Strategy]`

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-01-12 | v0.1 | Versioning & publish flow story draft | Bob (scrum-master) |
