rules_version = '2';

// Firebase Storage Security Rules for pod.style
// 遵循最小权限原则，确保用户只能访问自己的资源

service firebase.storage {
  match /b/{bucket}/o {
    
    // 辅助函数：检查用户是否已登录
    function isSignedIn() {
      return request.auth != null;
    }
    
    // 辅助函数：检查是否为资源所有者
    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    
    // 辅助函数：检查文件大小（字节）
    function isValidSize(maxSizeMB) {
      return request.resource.size <= maxSizeMB * 1024 * 1024;
    }
    
    // 辅助函数：检查文件类型
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    function isPrintFile() {
      return request.resource.contentType.matches('image/(tiff|png|jpeg)');
    }
    
    // uploads/{uid}/{creationId}/source.*
    // 用户上传的原始图片
    match /uploads/{uid}/{creationId}/{fileName} {
      // 用户可以读取和写入自己的上传文件
      allow read: if isOwner(uid);
      
      // 创建：必须是图片，大小 ≤ 10MB
      allow create: if isOwner(uid) 
                    && isImage() 
                    && isValidSize(10);
      
      // 更新：允许覆盖（例如重新生成）
      allow update: if isOwner(uid) 
                    && isImage() 
                    && isValidSize(10);
      
      // 删除：允许用户删除自己的文件
      allow delete: if isOwner(uid);
    }
    
    // previews/{creationId}/{sku}/{variant}/{size}.jpg
    // AI 生成的预览图（由后端写入）
    match /previews/{creationId}/{sku}/{variant}/{fileName} {
      // 所有登录用户可读（用于 Feed 浏览）
      allow read: if isSignedIn();
      
      // 仅后端可写（通过 Firebase Admin SDK）
      allow write: if false;
    }
    
    // prints/{orderId}/{lineItemId}/print-ready.tif
    // 生产级打印文件（由后端生成）
    match /prints/{orderId}/{lineItemId}/{fileName} {
      // 仅订单所有者可读（通过 metadata 验证）
      allow read: if isSignedIn() 
                  && resource.metadata.userId == request.auth.uid;
      
      // 仅后端可写
      allow write: if false;
    }
    
    // 临时文件路径（可选，用于 AI 处理中间结果）
    match /temp/{uid}/{sessionId}/{fileName} {
      // 用户可以读写自己的临时文件
      allow read, write: if isOwner(uid) 
                         && isValidSize(20);
      
      // 临时文件应由 Cloud Function 定期清理
    }
    
    // 用户头像（可选）
    match /avatars/{uid}/{fileName} {
      allow read: if isSignedIn();
      
      allow write: if isOwner(uid) 
                   && isImage() 
                   && isValidSize(2);
    }
    
    // 默认拒绝所有其他路径
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

