# 认证系统测试指南

## 测试环境准备

1. 打开浏览器的隐私/无痕模式（确保没有缓存的认证状态）
2. 打开开发者工具（F12）
3. 访问 http://localhost:9002

## 测试场景1: 匿名用户体验

### 步骤
1. 打开应用
2. 观察控制台日志
3. 检查用户状态

### 预期结果
- ✅ 应用自动加载
- ✅ 控制台显示匿名登录成功
- ✅ 可以看到首页内容
- ✅ 右上角显示"立即登录"按钮

### 验证点
```javascript
// 在控制台执行
firebase.auth().currentUser.isAnonymous
// 应该返回 true
```

## 测试场景2: 匿名用户生成创意

### 步骤
1. 在首页输入框输入创意描述，例如："一只可爱的猫咪"
2. 选择艺术风格（可选）
3. 点击"生成图案"按钮
4. 等待生成完成

### 预期结果
- ✅ 显示"AI 正在创作图案..."加载提示
- ✅ 生成成功后自动打开查看器
- ✅ 可以看到生成的图案
- ✅ 图案保存在"我的空间"中

### 验证点
- 检查Firestore中是否创建了新的creation文档
- userId应该是匿名用户的UID
- 文档应该包含所有必需字段

## 测试场景3: 匿名用户查看"我的空间"

### 步骤
1. 点击右上角的"我的空间"按钮
2. 查看"我的创作"标签页
3. 查看"我的订单"标签页

### 预期结果
- ✅ 可以看到刚才生成的创意
- ✅ 显示匿名用户提示："您的创作历史和订单仅保存在当前设备"
- ✅ 显示"注册或登录以永久保存"链接
- ✅ 可以点击创作查看详情

## 测试场景4: 匿名用户注册（账号升级）

### 步骤
1. 在"我的空间"点击"注册或登录"链接
2. 或者点击首页的"立即登录"按钮
3. 在登录界面点击"没有账户？点击注册"
4. 输入邮箱：test-upgrade@example.com
5. 输入密码：Test123456
6. 点击"创建账户"

### 预期结果
- ✅ 显示"注册成功"提示
- ✅ 提示"欢迎！您的匿名创作历史已保留。"
- ✅ 自动返回首页
- ✅ 右上角显示"我的空间"（不再显示"立即登录"）
- ✅ 在"我的空间"中可以看到之前的创作
- ✅ 不再显示匿名用户提示

### 验证点
```javascript
// 在控制台执行
firebase.auth().currentUser.isAnonymous
// 应该返回 false

firebase.auth().currentUser.email
// 应该返回 "test-upgrade@example.com"
```

### Firestore验证
- 检查之前创建的creation文档
- userId应该保持不变（因为是账号升级）
- 用户可以继续访问这些文档

## 测试场景5: 匿名用户登录已有账号（数据迁移）

### 准备工作
1. 先注册一个账号：existing@example.com / Test123456
2. 登出
3. 重新打开应用（获得新的匿名身份）
4. 生成一些创意（作为匿名用户）

### 步骤
1. 点击"立即登录"
2. 输入邮箱：existing@example.com
3. 输入密码：Test123456
4. 点击"登录"

### 预期结果
- ✅ 显示"登录成功"提示
- ✅ 显示"正在合并您的匿名创作历史..."提示
- ✅ 显示"欢迎回来, existing@example.com!"
- ✅ 显示"所有历史创作都已保留。"
- ✅ 自动返回首页
- ✅ 在"我的空间"中可以看到：
  - 原有账号的创作
  - 刚才匿名状态下创建的创作

### 验证点
```javascript
// 在控制台执行
firebase.auth().currentUser.email
// 应该返回 "existing@example.com"
```

### Firestore验证
- 检查匿名用户创建的creation文档
- userId应该已更新为existing@example.com的UID
- 所有文档都应该可以被新用户访问

## 测试场景6: 登录流程不闪退

### 步骤
1. 作为匿名用户，点击"立即登录"
2. 观察界面变化
3. 不要输入任何内容，只是停留在登录界面

### 预期结果
- ✅ 进入登录界面
- ✅ 界面保持稳定，不会自动跳转
- ✅ 可以正常输入邮箱和密码
- ✅ 可以点击"返回"按钮返回首页

### 验证点
- 登录界面应该保持显示
- 不应该自动跳转到首页
- 用户可以自由操作

## 测试场景7: 错误处理

### 7.1 邮箱已存在
1. 尝试注册已存在的邮箱
2. 预期：显示"该邮箱已被注册。请尝试登录。"

### 7.2 密码错误
1. 尝试用错误的密码登录
2. 预期：显示"邮箱或密码不正确。"

### 7.3 网络错误
1. 断开网络连接
2. 尝试登录或注册
3. 预期：显示"网络请求失败..."提示

## 测试场景8: 数据持久性

### 步骤
1. 作为正式用户登录
2. 生成一些创意
3. 刷新页面
4. 检查数据是否还在

### 预期结果
- ✅ 刷新后自动登录
- ✅ 所有创作都还在
- ✅ 用户状态保持

## 自动化测试脚本

```javascript
// 在浏览器控制台执行

// 测试1: 检查匿名用户状态
async function testAnonymousUser() {
  const user = firebase.auth().currentUser;
  console.assert(user !== null, '用户应该存在');
  console.assert(user.isAnonymous === true, '用户应该是匿名的');
  console.log('✅ 匿名用户测试通过');
}

// 测试2: 检查用户升级
async function testUserUpgrade() {
  const user = firebase.auth().currentUser;
  console.assert(user !== null, '用户应该存在');
  console.assert(user.isAnonymous === false, '用户不应该是匿名的');
  console.assert(user.email !== null, '用户应该有邮箱');
  console.log('✅ 用户升级测试通过');
}

// 测试3: 检查数据迁移
async function testDataMigration(oldUid, newUid) {
  // 这需要在服务器端验证
  console.log('检查数据迁移从', oldUid, '到', newUid);
  // 查询Firestore确认数据已迁移
}

// 运行测试
testAnonymousUser();
```

## 性能测试

### 测试指标
1. **匿名登录时间**
   - 目标：< 2秒
   - 测量：从页面加载到匿名用户创建完成

2. **注册响应时间**
   - 目标：< 3秒
   - 测量：从点击"创建账户"到注册成功

3. **登录响应时间**
   - 目标：< 3秒
   - 测量：从点击"登录"到登录成功

4. **数据迁移时间**
   - 目标：< 5秒（取决于数据量）
   - 测量：从登录成功到数据迁移完成

## 测试报告模板

```markdown
## 测试日期：2025-09-30

### 测试环境
- 浏览器：Chrome 120
- 操作系统：macOS
- 网络：WiFi

### 测试结果

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 匿名用户体验 | ✅ | 正常 |
| 生成创意 | ✅ | 正常 |
| 查看我的空间 | ✅ | 正常 |
| 注册升级 | ✅ | 正常 |
| 登录迁移 | ✅ | 正常 |
| 不闪退 | ✅ | 正常 |
| 错误处理 | ✅ | 正常 |
| 数据持久性 | ✅ | 正常 |

### 发现的问题
无

### 建议
无

### 测试人员
[您的名字]
```

## 常见问题排查

### 问题1: 匿名登录失败
**症状：** 控制台显示"Anonymous sign-in failed"
**排查：**
1. 检查Firebase配置是否正确
2. 检查Firebase控制台是否启用了匿名登录
3. 检查网络连接

### 问题2: 数据迁移失败
**症状：** 登录后看不到匿名创作
**排查：**
1. 检查控制台日志
2. 检查Firestore规则
3. 检查migrateAnonymousDataAction是否正确执行

### 问题3: 登录后闪退
**症状：** 登录成功后立即返回首页
**排查：**
1. 检查app-client.tsx的导航逻辑
2. 确认修复已应用
3. 清除浏览器缓存重试

## 总结

完成以上所有测试场景后，认证系统应该：
- ✅ 支持匿名用户体验所有功能
- ✅ 支持注册时自动保留数据
- ✅ 支持登录时正确迁移数据
- ✅ 不会出现闪退问题
- ✅ 错误处理友好
- ✅ 数据持久可靠
